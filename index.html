<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <meta name="theme-color" content="#1a1a2e">
  <meta name="description" content="BJ Probability Engine - Professional Blackjack Analysis">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="BJ Engine">

  <title>BJ Probability Engine v1.3</title>

  <!-- Performance: Preconnect to external origins -->
  <link rel="preconnect" href="https://cdn.jsdelivr.net" crossorigin>
  <link rel="dns-prefetch" href="https://cdn.jsdelivr.net">

  <!-- Performance: Preload critical CSS -->
  <link rel="preload" href="css/styles.css?v=3.9.56" as="style">

  <link rel="manifest" href="manifest.json">
  <link rel="icon" type="image/png" sizes="32x32" href="icons/icon-32x32.png">
  <link rel="apple-touch-icon" href="icons/icon-192x192.png">

  <link rel="stylesheet" href="css/styles.css?v=3.9.56">

  <!-- ML Libraries disabled - load only when AI detection is used -->
  <!-- <script async src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@4.17.0/dist/tf.min.js"></script> -->
  <!-- <script async src="https://cdn.jsdelivr.net/npm/@tensorflow-models/coco-ssd@2.2.3/dist/coco-ssd.min.js"></script> -->
  <!-- <script async src="https://cdn.jsdelivr.net/npm/onnxruntime-web@1.17.0/dist/ort.min.js"></script> -->
</head>
<body>
  <!-- Top Navigation Bar -->
  <nav class="top-nav">
    <div class="nav-tabs">
      <button class="nav-tab active" data-tab="game">Game</button>
      <button class="nav-tab" data-tab="config">Config</button>
      <button class="nav-tab" data-tab="rooms">Rooms</button>
      <button class="nav-tab" data-tab="players">Players</button>
      <button class="nav-tab" data-tab="spotters">Spotters</button>
      <button class="nav-tab" data-tab="history">Game History</button>
      <button class="nav-tab" data-tab="analytics">Analytics</button>
      <button class="nav-tab text-danger" id="btnClearCache">Clear Cache</button>
    </div>
    <div class="nav-center">
      <div class="table-indicator">
        <span class="table-icon">üé∞</span>
        <span>Table 1</span>
        <button class="btn-close-table">√ó</button>
      </div>
    </div>
    <div class="nav-right">
      <button class="btn-status btn-control">
        <span class="status-dot"></span>
        You have control
      </button>
      <button class="btn-status btn-disconnect">Disconnect</button>
    </div>
  </nav>

  <!-- Main Game Area -->
  <main class="game-area">
    <!-- Left Stats Panel -->
    <div class="stats-left">
      <div class="count-box running-count">
        <span id="runningCount" class="count-value">0</span>
        <span class="count-label">RUNNING<br>COUNT</span>
      </div>
      <div class="count-box true-count">
        <span id="trueCount" class="count-value">0.00</span>
        <span class="count-label">TRUE<br>COUNT</span>
      </div>

      <!-- Sit-Out Signal Panel -->
      <div class="sitout-signal-panel neutral" id="sitoutSignalPanel">
        <div class="sitout-signal-icon" id="sitoutIcon">‚è≥</div>
        <div class="sitout-signal-text" id="sitoutText">NEUTRAL</div>
        <div class="sitout-signal-reason" id="sitoutReason">TC 0.0 (wait)</div>
      </div>

      <!-- Combined Signal Panel (Double Danger Detection) -->
      <div class="combined-signal-panel safe" id="combinedSignalPanel">
        <div class="combined-signal-header">
          <span class="combined-signal-title">COMBINED SIGNAL</span>
        </div>
        <div class="combined-signal-level">
          <span class="signal-icon">‚óè</span>
          <span class="signal-label">NORMAL</span>
        </div>
        <div class="combined-signal-text">Normal conditions</div>
        <div class="combined-signal-reasons"></div>
        <div class="combined-signal-bet">
          <span class="bet-label">Bet:</span>
          <span class="combined-bet-mult">x1.00</span>
        </div>
      </div>

      <!-- Auto-Clump Indicator Panel -->
      <div class="clump-auto-indicator" id="clumpAutoIndicator">
        AUTO-CLUMP: OFF
      </div>

      <!-- Formula Info Button -->
      <button class="btn-formula-info" id="btnFormulaInfo">
        <span>?</span>
        Formulas & Strategy
      </button>

      <!-- Dealer's Cards This Round -->
      <div class="dealer-cards-panel">
        <div class="dealer-cards-header">DEALER</div>
        <div class="dealer-cards-display" id="dealerCardsLeft">
          <span class="no-cards">‚Äî</span>
        </div>
        <div class="dealer-total" id="dealerTotal">0</div>
      </div>

      <!-- Dealer Cards History -->
      <div class="dealer-history-panel">
        <div class="dealer-history-header">
          <span>HISTORY</span>
          <span class="round-count" id="roundCount">0</span>
        </div>
        <div class="dealer-history-list" id="dealerHistoryList">
          <div class="no-history">No rounds yet</div>
        </div>
      </div>

      <!-- Dealer Counter Panel (Holy Grail Engine) -->
      <div class="dealer-counter-panel" id="dealerCounterPanel">
        <div class="dealer-counter-header">
          <span class="dealer-counter-title">DEALER HOT</span>
          <span class="dealer-counter-level" id="dealerHotLevel">NEUTRAL</span>
        </div>
        <div class="dealer-counter-meter">
          <div class="dealer-counter-bar" id="dealerHotBar" style="width: 50%"></div>
          <span class="dealer-counter-score" id="dealerHotScore">50</span>
        </div>
        <div class="dealer-counter-stats">
          <div class="dealer-stat-row">
            <span class="stat-label">Bust Rate</span>
            <span class="stat-value" id="dealerBustRate">0%</span>
            <span class="stat-expected">(exp: 28%)</span>
          </div>
          <div class="dealer-stat-row">
            <span class="stat-label">20-21 Rate</span>
            <span class="stat-value" id="dealer2021Rate">0%</span>
            <span class="stat-expected">(exp: 25%)</span>
          </div>
          <div class="dealer-stat-row">
            <span class="stat-label">Win Streak</span>
            <span class="stat-value" id="dealerStreak">0</span>
          </div>
        </div>
        <div class="dealer-counter-signal" id="dealerCounterSignal">
          <span class="signal-icon">-</span>
          <span class="signal-text" id="dealerSignalText">Waiting for data...</span>
        </div>
      </div>
    </div>

    <!-- Right Stats Panel - Card Tracking -->
    <div class="stats-right">
      <div class="stat-boxes">
        <div class="stat-box aces-box">
          <span id="acesLeft" class="stat-value">32</span>
          <span class="stat-label">Aces Left</span>
        </div>
        <div class="stat-box pairs-box">
          <span id="pairsCount" class="stat-value">0</span>
          <span class="stat-label">Pairs</span>
        </div>
        <div class="stat-box cards-box">
          <span id="cardsSeen" class="stat-value">0/416</span>
          <span class="stat-label">Cards Seen</span>
        </div>
      </div>
      <div class="rank-table">
        <div class="rank-header">
          <span>Rank</span>
          <span>Seen</span>
          <span>Left</span>
          <span>% Left</span>
        </div>
        <div class="rank-row tens-row">
          <span class="rank-label">10</span>
          <span id="seen10" class="rank-seen">0</span>
          <span id="left10" class="rank-left">128</span>
          <span id="pct10" class="rank-pct">100</span>
        </div>
        <div class="rank-row">
          <span class="rank-label">2</span>
          <span id="seen2" class="rank-seen">0</span>
          <span id="left2" class="rank-left">32</span>
          <span id="pct2" class="rank-pct">100</span>
        </div>
        <div class="rank-row">
          <span class="rank-label">3</span>
          <span id="seen3" class="rank-seen">0</span>
          <span id="left3" class="rank-left">32</span>
          <span id="pct3" class="rank-pct">100</span>
        </div>
        <div class="rank-row">
          <span class="rank-label">4</span>
          <span id="seen4" class="rank-seen">0</span>
          <span id="left4" class="rank-left">32</span>
          <span id="pct4" class="rank-pct">100</span>
        </div>
        <div class="rank-row">
          <span class="rank-label">5</span>
          <span id="seen5" class="rank-seen">0</span>
          <span id="left5" class="rank-left">32</span>
          <span id="pct5" class="rank-pct">100</span>
        </div>
        <div class="rank-row">
          <span class="rank-label">6</span>
          <span id="seen6" class="rank-seen">0</span>
          <span id="left6" class="rank-left">32</span>
          <span id="pct6" class="rank-pct">100</span>
        </div>
        <div class="rank-row">
          <span class="rank-label">7</span>
          <span id="seen7" class="rank-seen">0</span>
          <span id="left7" class="rank-left">32</span>
          <span id="pct7" class="rank-pct">100</span>
        </div>
        <div class="rank-row">
          <span class="rank-label">8</span>
          <span id="seen8" class="rank-seen">0</span>
          <span id="left8" class="rank-left">32</span>
          <span id="pct8" class="rank-pct">100</span>
        </div>
        <div class="rank-row">
          <span class="rank-label">9</span>
          <span id="seen9" class="rank-seen">0</span>
          <span id="left9" class="rank-left">32</span>
          <span id="pct9" class="rank-pct">100</span>
        </div>
        <div class="rank-row">
          <span class="rank-label">A</span>
          <span id="seenA" class="rank-seen">0</span>
          <span id="leftA" class="rank-left">32</span>
          <span id="pctA" class="rank-pct">100</span>
        </div>
      </div>

      <!-- Bead Road Section -->
      <div class="bead-road-section">
        <div class="bead-road-header">
          <span>Bead Road</span>
          <button class="btn-clear-beads" onclick="clearBeadRoad()" title="Clear">√ó</button>
        </div>
        <div class="bead-road-grid" id="beadRoadGrid">
          <!-- Beads will be added dynamically -->
        </div>
        <div class="bead-road-legend">
          <span class="legend-item"><span class="bead-dot red"></span>2-6</span>
          <span class="legend-item"><span class="bead-dot blue"></span>7-9</span>
          <span class="legend-item"><span class="bead-dot green"></span>10-A</span>
        </div>
      </div>

      <!-- Shoe Composition Panel (Normal Probability) -->
      <div class="shoe-comp-section" id="shoeCompPanel">
        <div class="shoe-comp-header">
          <span class="shoe-comp-title">Shoe Composition</span>
          <label class="shoe-comp-toggle" title="Standard probability analysis">
            <input type="checkbox" id="shoeCompToggle" checked onchange="toggleShoeComp()">
            <span class="toggle-slider"></span>
          </label>
        </div>
        <div class="shoe-comp-content" id="shoeCompContent">
          <div class="shoe-comp-row">
            <span class="shoe-comp-label">High (10-A)</span>
            <span class="shoe-comp-value" id="shoeCompHigh">38.5%</span>
          </div>
          <div class="shoe-comp-row">
            <span class="shoe-comp-label">Low (2-6)</span>
            <span class="shoe-comp-value" id="shoeCompLow">38.5%</span>
          </div>
          <div class="shoe-comp-row">
            <span class="shoe-comp-label">Neutral (7-9)</span>
            <span class="shoe-comp-value" id="shoeCompNeutral">23.1%</span>
          </div>
          <div class="shoe-comp-divider"></div>
          <div class="shoe-comp-row">
            <span class="shoe-comp-label">Penetration</span>
            <span class="shoe-comp-value" id="shoeCompPen">0%</span>
          </div>
          <div class="shoe-comp-row">
            <span class="shoe-comp-label">Decks Left</span>
            <span class="shoe-comp-value" id="shoeCompDecks">8.0</span>
          </div>
          <div class="shoe-comp-status" id="shoeCompStatus">
            <span class="status-dot normal"></span>
            <span>Normal Distribution</span>
          </div>
        </div>
      </div>

      <!-- Anti-Clump Panel -->
      <div class="anti-clump-section" id="antiClumpPanel">
        <div class="anti-clump-header">
          <span class="anti-clump-title">Shuffle Quality</span>
          <label class="anti-clump-toggle" title="Enable when you suspect card clumping">
            <input type="checkbox" id="antiClumpToggle" onchange="toggleAntiClump()">
            <span class="toggle-slider"></span>
          </label>
        </div>
        <div class="anti-clump-content" id="antiClumpContent">
          <div class="anti-clump-score-row">
            <span class="anti-clump-score neutral">50%</span>
          </div>
          <div class="anti-clump-bar neutral">‚ñà‚ñà‚ñà‚ñà‚ñà‚ñë‚ñë‚ñë‚ñë‚ñë</div>
          <div class="anti-clump-details">
            <div class="anti-clump-rec neutral">NEUTRAL</div>
            <div class="anti-clump-strategy">Standard</div>
          </div>
          <div class="anti-clump-signals"></div>
        </div>
      </div>

      <!-- Clumping Probability Engine Panel -->
      <div class="clump-prob-section" id="clumpProbPanel">
        <div class="clump-prob-header">
          <span class="clump-prob-title">Clump Strategy</span>
          <label class="clump-prob-toggle" title="Enable clump-adjusted probability engine">
            <input type="checkbox" id="clumpProbToggle" onchange="toggleClumpProb()">
            <span class="toggle-slider"></span>
          </label>
        </div>
        <div class="clump-prob-content" id="clumpProbContent">
          <div class="clump-prob-momentum">
            <span class="momentum-label">Momentum</span>
            <span class="momentum-value neutral" id="clumpMomentum">NEUTRAL</span>
          </div>
          <div class="clump-prob-streak">
            <span class="streak-label">Streak</span>
            <span class="streak-value" id="clumpStreak">0</span>
          </div>
          <div class="clump-prob-divider"></div>
          <div class="clump-prob-action">
            <span class="action-label">Action</span>
            <span class="action-value" id="clumpAction">‚Äî</span>
          </div>
          <div class="clump-prob-reason" id="clumpReason">
            Enable to see clump-adjusted recommendations
          </div>
          <div class="clump-prob-ev">
            <span class="ev-label">Adj. EV</span>
            <span class="ev-value" id="clumpEV">‚Äî</span>
          </div>
        </div>
      </div>
    </div>

    <!-- Table Layout -->
    <div class="table-layout">
      <!-- Casino Blackjack Table -->
      <div class="casino-table">
        <span class="casino-name">Disruptor Casino</span>
        <span class="casino-table-text">BLACKJACK PAYS 3 TO 2</span>
        <div class="insurance-line"></div>
        <span class="insurance-text">INSURANCE PAYS 2 TO 1</span>

        <!-- Dealer Position -->
        <div class="dealer-area">
          <div class="dealer-box" id="dealerBox">
            <span class="position-label">DEALER</span>
            <span class="position-badge" id="dealerBadge">0</span>
            <div class="position-cards" id="dealerCards"></div>
            <span class="position-hint">Click to activate</span>
          </div>
        </div>

        <!-- Player Positions - 8 Seats -->
      <div class="players-row">
        <div class="player-box" data-seat="8" id="player8">
          <div class="player-header">
            <span class="player-dot"></span>
            <span class="position-label">PLAYER 8</span>
            <span class="position-badge">0</span>
            <label class="decision-toggle" title="Toggle decisions">
              <input type="checkbox" class="decision-toggle-input" data-player="8">
              <span class="decision-toggle-slider"></span>
            </label>
          </div>
          <div class="position-cards"></div>
          <div class="decision-panel" data-player="8">
            <button class="decision-btn stay" onclick="recordDecision(8, 'STAY')">S</button>
            <button class="decision-btn hit" onclick="recordDecision(8, 'HIT')">H</button>
            <button class="decision-btn split" onclick="recordDecision(8, 'SPLIT')">P</button>
            <button class="decision-btn double" onclick="recordDecision(8, 'DBL')">D</button>
          </div>
          <span class="position-hint">Click to activate</span>
        </div>
        <div class="player-box" data-seat="7" id="player7">
          <div class="player-header">
            <span class="player-dot"></span>
            <span class="position-label">PLAYER 7</span>
            <span class="position-badge">0</span>
            <label class="decision-toggle" title="Toggle decisions">
              <input type="checkbox" class="decision-toggle-input" data-player="7">
              <span class="decision-toggle-slider"></span>
            </label>
          </div>
          <div class="position-cards"></div>
          <div class="decision-panel" data-player="7">
            <button class="decision-btn stay" onclick="recordDecision(7, 'STAY')">S</button>
            <button class="decision-btn hit" onclick="recordDecision(7, 'HIT')">H</button>
            <button class="decision-btn split" onclick="recordDecision(7, 'SPLIT')">P</button>
            <button class="decision-btn double" onclick="recordDecision(7, 'DBL')">D</button>
          </div>
          <span class="position-hint">Click to activate</span>
        </div>
        <div class="player-box" data-seat="6" id="player6">
          <div class="player-header">
            <span class="player-dot"></span>
            <span class="position-label">PLAYER 6</span>
            <span class="position-badge">0</span>
            <label class="decision-toggle" title="Toggle decisions">
              <input type="checkbox" class="decision-toggle-input" data-player="6">
              <span class="decision-toggle-slider"></span>
            </label>
          </div>
          <div class="position-cards"></div>
          <div class="decision-panel" data-player="6">
            <button class="decision-btn stay" onclick="recordDecision(6, 'STAY')">S</button>
            <button class="decision-btn hit" onclick="recordDecision(6, 'HIT')">H</button>
            <button class="decision-btn split" onclick="recordDecision(6, 'SPLIT')">P</button>
            <button class="decision-btn double" onclick="recordDecision(6, 'DBL')">D</button>
          </div>
          <span class="position-hint">Click to activate</span>
        </div>
        <div class="player-box" data-seat="5" id="player5">
          <div class="player-header">
            <span class="player-dot"></span>
            <span class="position-label">PLAYER 5</span>
            <span class="position-badge">0</span>
            <label class="decision-toggle" title="Toggle decisions">
              <input type="checkbox" class="decision-toggle-input" data-player="5">
              <span class="decision-toggle-slider"></span>
            </label>
          </div>
          <div class="position-cards"></div>
          <div class="decision-panel" data-player="5">
            <button class="decision-btn stay" onclick="recordDecision(5, 'STAY')">S</button>
            <button class="decision-btn hit" onclick="recordDecision(5, 'HIT')">H</button>
            <button class="decision-btn split" onclick="recordDecision(5, 'SPLIT')">P</button>
            <button class="decision-btn double" onclick="recordDecision(5, 'DBL')">D</button>
          </div>
          <span class="position-hint">Click to activate</span>
        </div>
        <div class="player-box" data-seat="4" id="player4">
          <div class="player-header">
            <span class="player-dot"></span>
            <span class="position-label">PLAYER 4</span>
            <span class="position-badge">0</span>
            <label class="decision-toggle" title="Toggle decisions">
              <input type="checkbox" class="decision-toggle-input" data-player="4">
              <span class="decision-toggle-slider"></span>
            </label>
          </div>
          <div class="position-cards"></div>
          <div class="decision-panel" data-player="4">
            <button class="decision-btn stay" onclick="recordDecision(4, 'STAY')">S</button>
            <button class="decision-btn hit" onclick="recordDecision(4, 'HIT')">H</button>
            <button class="decision-btn split" onclick="recordDecision(4, 'SPLIT')">P</button>
            <button class="decision-btn double" onclick="recordDecision(4, 'DBL')">D</button>
          </div>
          <span class="position-hint">Click to activate</span>
        </div>
        <div class="player-box" data-seat="3" id="player3">
          <div class="player-header">
            <span class="player-dot"></span>
            <span class="position-label">PLAYER 3</span>
            <span class="position-badge">0</span>
            <label class="decision-toggle" title="Toggle decisions">
              <input type="checkbox" class="decision-toggle-input" data-player="3">
              <span class="decision-toggle-slider"></span>
            </label>
          </div>
          <div class="position-cards"></div>
          <div class="decision-panel" data-player="3">
            <button class="decision-btn stay" onclick="recordDecision(3, 'STAY')">S</button>
            <button class="decision-btn hit" onclick="recordDecision(3, 'HIT')">H</button>
            <button class="decision-btn split" onclick="recordDecision(3, 'SPLIT')">P</button>
            <button class="decision-btn double" onclick="recordDecision(3, 'DBL')">D</button>
          </div>
          <span class="position-hint">Click to activate</span>
        </div>
        <div class="player-box" data-seat="2" id="player2">
          <div class="player-header">
            <span class="player-dot"></span>
            <span class="position-label">PLAYER 2</span>
            <span class="position-badge">0</span>
            <label class="decision-toggle" title="Toggle decisions">
              <input type="checkbox" class="decision-toggle-input" data-player="2">
              <span class="decision-toggle-slider"></span>
            </label>
          </div>
          <div class="position-cards"></div>
          <div class="decision-panel" data-player="2">
            <button class="decision-btn stay" onclick="recordDecision(2, 'STAY')">S</button>
            <button class="decision-btn hit" onclick="recordDecision(2, 'HIT')">H</button>
            <button class="decision-btn split" onclick="recordDecision(2, 'SPLIT')">P</button>
            <button class="decision-btn double" onclick="recordDecision(2, 'DBL')">D</button>
          </div>
          <span class="position-hint">Click to activate</span>
        </div>
        <div class="player-box active" data-seat="1" id="player1">
          <div class="player-header">
            <span class="player-dot"></span>
            <span class="position-label">PLAYER 1</span>
            <span class="position-badge">0</span>
            <label class="decision-toggle" title="Toggle decisions">
              <input type="checkbox" class="decision-toggle-input" data-player="1">
              <span class="decision-toggle-slider"></span>
            </label>
          </div>
          <div class="position-cards"></div>
          <div class="decision-panel" data-player="1">
            <button class="decision-btn stay" onclick="recordDecision(1, 'STAY')">S</button>
            <button class="decision-btn hit" onclick="recordDecision(1, 'HIT')">H</button>
            <button class="decision-btn split" onclick="recordDecision(1, 'SPLIT')">P</button>
            <button class="decision-btn double" onclick="recordDecision(1, 'DBL')">D</button>
          </div>
          <span class="position-hint">Click to activate</span>
        </div>
      </div>
      </div> <!-- End Casino Table -->

      <!-- Bet Controls -->
      <div class="bet-controls">
        <label class="toggle-control">
          <span>Time To Bet</span>
          <input type="checkbox" id="timeToBet">
          <span class="toggle-slider"></span>
        </label>
        <label class="toggle-control">
          <span>Lock Bet</span>
          <input type="checkbox" id="lockBet">
          <span class="toggle-slider"></span>
        </label>
      </div>

      <!-- Card Input Grid -->
      <div class="card-input-area">
        <button class="btn-reset-round" id="btnResetRound">
          Reset<br>Round
        </button>

        <div class="card-grid">
          <div class="card-row">
            <button class="card-btn low" data-card="2">2</button>
            <button class="card-btn low" data-card="3">3</button>
            <button class="card-btn low" data-card="4">4</button>
            <button class="card-btn low" data-card="5">5</button>
            <button class="card-btn low" data-card="6">6</button>
            <button class="card-btn neutral" data-card="7">7</button>
          </div>
          <div class="card-row">
            <button class="card-btn neutral" data-card="8">8</button>
            <button class="card-btn neutral" data-card="9">9</button>
            <button class="card-btn high" data-card="10">10</button>
            <button class="card-btn high" data-card="J">J</button>
            <button class="card-btn high" data-card="Q">Q</button>
            <button class="card-btn high" data-card="K">K</button>
            <button class="card-btn high" data-card="A">A</button>
          </div>
        </div>

        <button class="btn-undo" id="btnUndo">
          Undo<br>(U)
        </button>
      </div>

      <!-- Game Controls -->
      <div class="game-controls">
        <div class="control-item">
          <label>Players</label>
          <select id="numPlayers" onchange="setNumPlayers(parseInt(this.value))">
            <option value="1">1</option>
            <option value="2">2</option>
            <option value="3">3</option>
            <option value="4">4</option>
            <option value="5">5</option>
            <option value="6">6</option>
            <option value="7" selected>7</option>
            <option value="8">8</option>
          </select>
        </div>
        <div class="control-item">
          <label>Strategy</label>
          <select id="strategyVersionSelect" onchange="applyStrategyVersion(parseInt(this.value))">
            <option value="1">V1 (5-seat)</option>
            <option value="2" selected>V2 (7-seat)</option>
          </select>
        </div>
        <div class="control-item">
          <label>Dice rank</label>
          <select id="diceRank">
            <option value="none">(none)</option>
            <option value="A">A</option>
            <option value="2">2</option>
            <option value="3">3</option>
            <option value="4">4</option>
            <option value="5">5</option>
            <option value="6">6</option>
            <option value="7">7</option>
            <option value="8">8</option>
            <option value="9">9</option>
            <option value="10">10</option>
            <option value="J">J</option>
            <option value="Q">Q</option>
            <option value="K">K</option>
          </select>
        </div>
        <div class="control-item dice-mapping">
          <label>Dice mapping</label>
          <select id="diceMapping">
            <option value="standard">A=1, 2-10=pip, J/Q/K=10</option>
            <option value="hilo">A=-1, 2-6=+1, 7-9=0, 10-K=-1</option>
            <option value="custom">Custom mapping</option>
          </select>
        </div>
        <button class="btn-apply" id="btnApplySettings">Apply</button>
        <button class="btn-history" id="btnHistory" onclick="showHistoryPanel()">HISTORY</button>
        <button class="btn-settle" id="btnSettleRound" onclick="autoSettleRound()">SETTLE</button>
        <button class="btn-new-round" id="btnNewRound" onclick="newRound()">NEW</button>
        <div class="sim-config-selector">
          <div class="sim-config-item">
            <label for="simDecksSelect">Decks:</label>
            <select id="simDecksSelect">
              <option value="1">1</option>
              <option value="2">2</option>
              <option value="4">4</option>
              <option value="8">8</option>
              <option value="16">16</option>
              <option value="32" selected>32</option>
              <option value="64">64</option>
              <option value="100">100</option>
              <option value="200">200</option>
              <option value="300">300</option>
              <option value="400">400</option>
              <option value="500">500</option>
              <option value="600">600</option>
              <option value="700">700</option>
              <option value="800">800</option>
              <option value="900">900</option>
              <option value="1000">1000</option>
            </select>
          </div>
          <div class="sim-config-item">
            <label for="simPlayersSelect">Players:</label>
            <select id="simPlayersSelect" onchange="updateSimPlayerCount()">
              <option value="1">1</option>
              <option value="2">2</option>
              <option value="3">3</option>
              <option value="4">4</option>
              <option value="5" selected>5</option>
              <option value="6">6</option>
              <option value="7">7</option>
            </select>
          </div>
        </div>

        <!-- Simulation Settings Panel -->
        <div class="sim-settings-panel" id="simSettingsPanel" style="background:linear-gradient(135deg,#1a1a2e,#252545);border:2px solid #8b5cf6;border-radius:10px;padding:12px;margin:10px 0;">

          <!-- Header with Toggle -->
          <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px;cursor:pointer;" onclick="toggleSettingsPanel()">
            <span style="color:#8b5cf6;font-weight:bold;font-size:14px;">‚öôÔ∏è SIMULATION SETTINGS</span>
            <span id="settingsToggleIcon" style="color:#8b5cf6;font-size:16px;">‚ñ∂</span>
          </div>

          <!-- Collapsible Settings Content -->
          <div id="settingsContent" style="display:none;">

            <!-- SECTION 1: Table Settings -->
            <div style="background:#1a1a2e;border:1px solid #22d3ee;border-radius:6px;padding:10px;margin-bottom:10px;">
              <div style="color:#22d3ee;font-size:12px;font-weight:bold;margin-bottom:8px;">üìã TABLE SETTINGS</div>
              <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:8px;">
                <div style="display:flex;flex-direction:column;gap:4px;">
                  <label style="color:#888;font-size:10px;">Decks:</label>
                  <select id="settingsDecks" onchange="applySimSettings()" style="background:#252545;color:#fff;border:1px solid #444;border-radius:4px;padding:4px;font-size:11px;">
                    <option value="1">1</option>
                    <option value="2">2</option>
                    <option value="4">4</option>
                    <option value="6">6</option>
                    <option value="8" selected>8</option>
                    <option value="16">16</option>
                    <option value="32">32</option>
                    <option value="64">64</option>
                    <option value="100">100</option>
                    <option value="200">200</option>
                    <option value="500">500</option>
                    <option value="1000">1000</option>
                  </select>
                </div>
                <div style="display:flex;flex-direction:column;gap:4px;">
                  <label style="color:#888;font-size:10px;">Players:</label>
                  <select id="settingsPlayers" onchange="applySimSettings()" style="background:#252545;color:#fff;border:1px solid #444;border-radius:4px;padding:4px;font-size:11px;">
                    <option value="1">1</option>
                    <option value="2">2</option>
                    <option value="3">3</option>
                    <option value="4">4</option>
                    <option value="5" selected>5</option>
                    <option value="6">6</option>
                    <option value="7">7</option>
                  </select>
                </div>
                <div style="display:flex;flex-direction:column;gap:4px;">
                  <label style="color:#888;font-size:10px;">Penetration:</label>
                  <select id="settingsPenetration" onchange="applySimSettings()" style="background:#252545;color:#fff;border:1px solid #444;border-radius:4px;padding:4px;font-size:11px;">
                    <option value="50">50%</option>
                    <option value="65">65%</option>
                    <option value="75" selected>75%</option>
                    <option value="85">85%</option>
                    <option value="90">90%</option>
                  </select>
                </div>
              </div>
            </div>

            <!-- SECTION 2: P1 Settings (Quant EV) -->
            <div style="background:#1a1a2e;border:1px solid #f59e0b;border-radius:6px;padding:10px;margin-bottom:10px;">
              <div style="color:#f59e0b;font-size:12px;font-weight:bold;margin-bottom:8px;">üéØ PLAYER 1 (QUANT EV)</div>

              <!-- P1 Strategy -->
              <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-bottom:8px;">
                <div style="display:flex;flex-direction:column;gap:4px;">
                  <label style="color:#888;font-size:10px;">Strategy:</label>
                  <select id="settingsP1Strategy" onchange="applySimSettings()" style="background:#252545;color:#fff;border:1px solid #444;border-radius:4px;padding:4px;font-size:11px;">
                    <option value="quantEv" selected>Quant EV + I18</option>
                    <option value="quantEvT25">QEV + Top 2-5 Override</option>
                    <option value="basic">Basic Strategy</option>
                  </select>
                </div>
                <div style="display:flex;flex-direction:column;gap:4px;">
                  <label style="color:#888;font-size:10px;">TC Entry Threshold:</label>
                  <input type="number" id="settingsP1TcThreshold" value="0.9" step="0.1" min="-5" max="10" onchange="applySimSettings()" style="background:#252545;color:#22c55e;border:1px solid #444;border-radius:4px;padding:4px;font-size:11px;text-align:center;">
                </div>
              </div>

              <!-- P1 Bankroll & Betting -->
              <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:8px;margin-bottom:8px;">
                <div style="display:flex;flex-direction:column;gap:4px;">
                  <label style="color:#888;font-size:10px;">Bankroll ($):</label>
                  <input type="number" id="settingsP1Bankroll" value="100000" min="1000" max="10000000" step="1000" onchange="applySimSettings()" style="background:#252545;color:#22c55e;border:1px solid #444;border-radius:4px;padding:4px;font-size:11px;text-align:center;">
                </div>
                <div style="display:flex;flex-direction:column;gap:4px;">
                  <label style="color:#888;font-size:10px;">Bet % of Bank:</label>
                  <input type="number" id="settingsP1BetPercent" value="5" min="0.5" max="25" step="0.5" onchange="applySimSettings()" style="background:#252545;color:#f59e0b;border:1px solid #444;border-radius:4px;padding:4px;font-size:11px;text-align:center;">
                </div>
                <div style="display:flex;flex-direction:column;gap:4px;">
                  <label style="color:#888;font-size:10px;">Base Bet ($):</label>
                  <input type="number" id="settingsP1BaseBet" value="5000" min="1" max="100000" onchange="applySimSettings()" style="background:#252545;color:#fff;border:1px solid #444;border-radius:4px;padding:4px;font-size:11px;text-align:center;" readonly>
                </div>
              </div>

              <!-- P1 Bet Method -->
              <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:8px;">
                <div style="display:flex;flex-direction:column;gap:4px;">
                  <label style="color:#888;font-size:10px;">Bet Method:</label>
                  <select id="settingsP1BetMethod" onchange="applySimSettings()" style="background:#252545;color:#fff;border:1px solid #444;border-radius:4px;padding:4px;font-size:11px;">
                    <option value="flat">Flat Betting</option>
                    <option value="martingale" selected>Martingale</option>
                    <option value="kelly">Kelly Criterion</option>
                    <option value="spread">1-12 Spread</option>
                  </select>
                </div>
                <div style="display:flex;flex-direction:column;gap:4px;">
                  <label style="color:#888;font-size:10px;">Martingale Max:</label>
                  <select id="settingsP1MartingaleMax" onchange="applySimSettings()" style="background:#252545;color:#fff;border:1px solid #444;border-radius:4px;padding:4px;font-size:11px;">
                    <option value="2">2x</option>
                    <option value="3" selected>3x</option>
                    <option value="4">4x</option>
                    <option value="5">5x</option>
                    <option value="8">8x</option>
                    <option value="16">16x</option>
                  </select>
                </div>
                <div style="display:flex;flex-direction:column;gap:4px;">
                  <label style="color:#888;font-size:10px;">Max Bet ($):</label>
                  <input type="number" id="settingsP1MaxBet" value="15000" readonly style="background:#1a1a2e;color:#ef4444;border:1px solid #444;border-radius:4px;padding:4px;font-size:11px;text-align:center;">
                </div>
              </div>
            </div>

            <!-- SECTION 3: P2-P5 Settings (Basic Strategy) -->
            <div style="background:#1a1a2e;border:1px solid #a78bfa;border-radius:6px;padding:10px;margin-bottom:10px;">
              <div style="color:#a78bfa;font-size:12px;font-weight:bold;margin-bottom:8px;">üë• PLAYERS 2-5 (BASIC STRATEGY)</div>
              <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:8px;">
                <div style="display:flex;flex-direction:column;gap:4px;">
                  <label style="color:#888;font-size:10px;">Strategy:</label>
                  <select id="settingsP2Strategy" onchange="applySimSettings()" style="background:#252545;color:#fff;border:1px solid #444;border-radius:4px;padding:4px;font-size:11px;">
                    <option value="basic" selected>Basic Strategy</option>
                    <option value="quantEv">Quant EV</option>
                  </select>
                </div>
                <div style="display:flex;flex-direction:column;gap:4px;">
                  <label style="color:#888;font-size:10px;">Bankroll ($):</label>
                  <input type="number" id="settingsP2Bankroll" value="100000" min="1000" max="10000000" step="1000" onchange="applySimSettings()" style="background:#252545;color:#22c55e;border:1px solid #444;border-radius:4px;padding:4px;font-size:11px;text-align:center;">
                </div>
                <div style="display:flex;flex-direction:column;gap:4px;">
                  <label style="color:#888;font-size:10px;">Flat Bet ($):</label>
                  <input type="number" id="settingsP2FlatBet" value="5000" min="1" max="100000" onchange="applySimSettings()" style="background:#252545;color:#fff;border:1px solid #444;border-radius:4px;padding:4px;font-size:11px;text-align:center;">
                </div>
              </div>
            </div>

            <!-- SECTION 4: Surrender Settings -->
            <div style="background:#1a1a2e;border:1px solid #f472b6;border-radius:6px;padding:10px;margin-bottom:10px;">
              <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;">
                <span style="color:#f472b6;font-size:12px;font-weight:bold;">üè≥Ô∏è SURRENDER STRATEGY</span>
                <label style="display:flex;align-items:center;gap:6px;cursor:pointer;">
                  <input type="checkbox" id="settingsSurrenderEnabled" checked onchange="applySimSettings()" style="width:14px;height:14px;accent-color:#f472b6;">
                  <span style="color:#aaa;font-size:10px;">Enabled</span>
                </label>
              </div>
              <div style="color:#888;font-size:10px;line-height:1.4;">
                <div style="margin-bottom:4px;">‚Ä¢ Hard 16 vs 9, 10, A ‚Üí SURRENDER</div>
                <div>‚Ä¢ Hard 15 vs 10 ‚Üí SURRENDER</div>
              </div>
            </div>

            <!-- SECTION 5: Post-Deal Override Settings -->
            <div style="background:#1a1a2e;border:1px solid #ef4444;border-radius:6px;padding:10px;margin-bottom:10px;">
              <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;">
                <span style="color:#ef4444;font-size:12px;font-weight:bold;">üîÑ POST-DEAL OVERRIDE (Top 2-5)</span>
                <label style="display:flex;align-items:center;gap:6px;cursor:pointer;">
                  <input type="checkbox" id="settingsOverrideEnabled" checked onchange="applySimSettings()" style="width:14px;height:14px;accent-color:#ef4444;">
                  <span style="color:#aaa;font-size:10px;">Enabled</span>
                </label>
              </div>
              <div style="color:#888;font-size:10px;line-height:1.4;">
                <div style="margin-bottom:4px;">‚Ä¢ Hard 15 vs 9/10: STAY if Top 2-5 has 7,8,9</div>
                <div style="margin-bottom:4px;">‚Ä¢ Hard 16 vs 9/10: STAY if Top 2-5 has 6,7,8,9</div>
                <div style="color:#f59e0b;font-size:9px;margin-top:4px;">Note: Override takes priority over Surrender when applicable</div>
              </div>
            </div>

            <!-- Settings Summary -->
            <div id="settingsSummary" style="background:#252545;border-radius:6px;padding:8px;margin-bottom:10px;">
              <div style="color:#22c55e;font-size:11px;font-weight:bold;">üìä CURRENT CONFIG:</div>
              <div id="settingsSummaryText" style="color:#aaa;font-size:10px;margin-top:4px;line-height:1.5;">
                P1: QEV+MG+T25 | $100k | 5% ($5,000) | MG 3x max<br>
                P2-P5: Basic Strategy | $100k | Flat $5,000
              </div>
            </div>

            <!-- Action Buttons -->
            <div style="display:flex;gap:8px;justify-content:space-between;">
              <button onclick="resetSimSettings()" style="background:#374151;color:#fff;border:none;border-radius:4px;padding:6px 12px;font-size:11px;cursor:pointer;flex:1;">Reset Defaults</button>
              <button onclick="saveSimSettings()" style="background:#22c55e;color:#fff;border:none;border-radius:4px;padding:6px 12px;font-size:11px;cursor:pointer;flex:1;">Save Settings</button>
              <button id="trackerToggleBtn" onclick="toggleTrackerPanel()" style="background:#8b5cf6;color:white;border:none;border-radius:4px;padding:6px 12px;font-size:11px;cursor:pointer;flex:1;">Show Tracker</button>
            </div>
          </div>
        </div>
        <button class="btn-simulate-rt" id="btnSimulateRT" onclick="startSimWithConfig()">LIVE SIM</button>
        <button class="btn-simulate-shoe" id="btnSimulateShoe" onclick="simulateOneShoe()">1 SHOE</button>
        <button class="btn-full-sim" id="btnFullSim" onclick="runFullEngineSimulation()">FULL SIM</button>
        <button class="btn-end-game" id="btnEndGame">END GAME</button>
        <button class="btn-history" id="btnGameHistory" onclick="showGameHistoryPanel()">üìä HISTORY</button>
      </div>

    </div>

    <!-- Composition Metrics Panel -->
    <div class="metrics-panel">
      <div class="metrics-header">
        <span class="metrics-icon">‚â°</span>
        <span>Composition Metrics</span>
        <span class="metrics-status" id="metricsStatus">ACTIVE</span>
      </div>
      <div class="metrics-grid">
        <div class="metric-box">
          <div class="metric-row">
            <span class="metric-label">P(WIN):</span>
            <span id="pWin" class="metric-value">42.0%</span>
          </div>
          <span class="metric-desc">Est. round win probability</span>
        </div>
        <div class="metric-box">
          <div class="metric-row">
            <span class="metric-label">EV:</span>
            <span id="evValue" class="metric-value">-6.52%</span>
          </div>
          <span class="metric-desc">Expected value per unit bet</span>
        </div>
        <div class="metric-box">
          <div class="metric-row">
            <span class="metric-label">S-SCORE:</span>
            <span id="sScore" class="metric-value">0.0000</span>
          </div>
          <span class="metric-desc">Tens + aces vs baseline</span>
        </div>
        <div class="metric-box">
          <div class="metric-row">
            <span class="metric-label">PENETRATION:</span>
            <span id="penetration" class="metric-value">0.0%</span>
          </div>
          <span class="metric-desc" id="penDesc">0 / 8 decks seen</span>
        </div>
        <div class="metric-box">
          <div class="metric-row">
            <span class="metric-label">P(TENS):</span>
            <span id="pTens" class="metric-value">30.8%</span>
          </div>
          <span class="metric-desc">Draw 10, J, Q, or K</span>
        </div>
        <div class="metric-box">
          <div class="metric-row">
            <span class="metric-label">P(ACES):</span>
            <span id="pAces" class="metric-value">7.7%</span>
          </div>
          <span class="metric-desc">Draw an Ace</span>
        </div>
        <div class="metric-box">
          <div class="metric-row">
            <span class="metric-label">P(7-A):</span>
            <span id="p7A" class="metric-value">61.5%</span>
          </div>
          <span class="metric-desc">Draw 7 through Ace</span>
        </div>
        <div class="metric-box">
          <div class="metric-row">
            <span class="metric-label">COMP BIAS:</span>
            <span id="compBias" class="metric-value status-inactive">Inactive</span>
          </div>
          <span class="metric-desc">4+ decks & S‚â†0.012</span>
        </div>
      </div>

      <!-- Additional Probability Engines -->
      <div class="metrics-grid mt-10">
        <div class="metric-box highlight">
          <div class="metric-row">
            <span class="metric-label">ANY PAIR:</span>
            <span id="anyPairProb" class="metric-value">7.47%</span>
          </div>
          <span class="metric-desc">P(Pair on first 2 cards)</span>
        </div>
        <div class="metric-box highlight">
          <div class="metric-row">
            <span class="metric-label">PAIR EV:</span>
            <span id="anyPairEV" class="metric-value">-0.029</span>
          </div>
          <span class="metric-desc">Expected value @ 12:1</span>
        </div>
        <div class="metric-box">
          <div class="metric-row">
            <span class="metric-label">SEAT ADJ:</span>
            <span id="seatAdj" class="metric-value">1.0000</span>
          </div>
          <span class="metric-desc">Seat position multiplier</span>
        </div>
        <div class="metric-box">
          <div class="metric-row">
            <span class="metric-label">WINDOW:</span>
            <span id="windowDecision" class="metric-value decision-neutral">‚Äî</span>
          </div>
          <span class="metric-desc">BET / NO_BET decision</span>
        </div>
        <div class="metric-box">
          <div class="metric-row">
            <span class="metric-label">SCORE:</span>
            <span id="windowScore" class="metric-value">50</span>
          </div>
          <span class="metric-desc">Window detector score</span>
        </div>
        <div class="metric-box">
          <div class="metric-row">
            <span class="metric-label">KELLY:</span>
            <span id="kellyFrac" class="metric-value">0.50</span>
          </div>
          <span class="metric-desc">Recommended bet fraction</span>
        </div>
        <div class="metric-box">
          <div class="metric-row">
            <span class="metric-label">21+3 EV:</span>
            <span id="t21p3EV" class="metric-value">-0.034</span>
          </div>
          <span class="metric-desc">Three-card poker side bet</span>
        </div>
        <div class="metric-box">
          <div class="metric-row">
            <span class="metric-label">TEMPORAL:</span>
            <span id="temporalRec" class="metric-value">STAY</span>
          </div>
          <span class="metric-desc">Table recommendation</span>
        </div>
      </div>

      <div class="metrics-footer">
        <span><strong>S-Score:</strong> Composition edge proxy</span>
        <span><strong>Deep Pen:</strong> 4+ decks for surrender bias</span>
      </div>

      <!-- Advanced Tools Section -->
      <div class="advanced-tools-section">
        <div class="tools-section-header" onclick="toggleAdvancedToolsSection()">
          <span class="tools-icon">‚ö°</span>
          <span>Advanced Tools</span>
          <span class="tools-toggle" id="toolsSectionToggle">‚ñº</span>
        </div>
        <div class="tools-section-grid" id="toolsSectionGrid">
          <button class="btn-tool-sm" onclick="showHandAnalyzer()">
            <span class="tool-icon">üéØ</span>
            <span class="tool-label">Hand Analyzer</span>
          </button>
          <button class="btn-tool-sm" onclick="showRiskOfRuinCalculator()">
            <span class="tool-icon">üìâ</span>
            <span class="tool-label">Risk of Ruin</span>
          </button>
          <button class="btn-tool-sm" onclick="showVarianceCalculator()">
            <span class="tool-icon">üìä</span>
            <span class="tool-label">Variance Calc</span>
          </button>
          <button class="btn-tool-sm" onclick="startTrainingMode()">
            <span class="tool-icon">üéì</span>
            <span class="tool-label">Training Mode</span>
          </button>
          <button class="btn-tool-sm" onclick="showSessionTrackerPanel()">
            <span class="tool-icon">üí∞</span>
            <span class="tool-label">Session Tracker</span>
          </button>
          <button class="btn-tool-sm" onclick="showBetSpreadOptimizer()">
            <span class="tool-icon">üìà</span>
            <span class="tool-label">Bet Optimizer</span>
          </button>
          <button class="btn-tool-sm" onclick="showCountSystemsPanel()">
            <span class="tool-icon">üî¢</span>
            <span class="tool-label">Count Systems</span>
          </button>
          <button class="btn-tool-sm" onclick="showAceSequencer()">
            <span class="tool-icon">üÉè</span>
            <span class="tool-label">Ace Sequencing</span>
          </button>
          <button class="btn-tool-sm" onclick="showHeatIndexPanel()">
            <span class="tool-icon">üî•</span>
            <span class="tool-label">Heat Index</span>
          </button>
          <button class="btn-tool-sm" onclick="showWongingSignals()">
            <span class="tool-icon">üö¶</span>
            <span class="tool-label">Wonging</span>
          </button>
          <button class="btn-tool-sm" onclick="showShoeReplay()">
            <span class="tool-icon">üîÑ</span>
            <span class="tool-label">Shoe Replay</span>
          </button>
          <button class="btn-tool-sm" onclick="showVideoTracker()">
            <span class="tool-icon">üé•</span>
            <span class="tool-label">Video Tracker</span>
          </button>
          <button class="btn-tool-sm" id="btnThemeToggle2" onclick="toggleTheme()">
            <span class="tool-icon">üåô</span>
            <span class="tool-label">Dark/Light</span>
          </button>
          <button class="btn-tool-sm" id="btnAudioToggle2" onclick="toggleAudio()">
            <span class="tool-icon">üîä</span>
            <span class="tool-label">Audio Alerts</span>
          </button>
          <button class="btn-tool-sm" id="btnTouchMode2" onclick="toggleMobileTouchMode()">
            <span class="tool-icon">üëÜ</span>
            <span class="tool-label">Touch Mode</span>
          </button>
        </div>
      </div>
    </div>

  </main>

  <!-- Bottom History Section -->
  <section class="bottom-history-section" id="bottomHistorySection">
    <!-- Dealer Bust History Panel -->
    <div class="history-panel-card" id="dealerBustHistoryCard">
      <div class="history-panel-header" onclick="toggleHistoryPanel('dealerBust')">
        <span class="history-panel-title">üí• DEALER BUST HISTORY</span>
        <span class="history-panel-toggle" id="dealerBustToggleIcon">‚ñº</span>
      </div>
      <div class="history-panel-body" id="dealerBustHistoryPanel">
        <div class="bust-history-header">
          <div class="bust-rate-main">
            <span class="bust-rate-label">DEALER BUST RATE</span>
            <span class="bust-rate-value" id="bustRateValue">0.0%</span>
            <span class="bust-rate-count" id="bustRateCount">(0/0)</span>
          </div>
          <div class="expected-rate">Expected: 28.0%</div>
        </div>
        <div class="bust-history-grid" id="bustHistoryGrid">
          <div class="bust-empty">Start simulation to track dealer busts</div>
        </div>
      </div>
    </div>

    <!-- QEV Live Tracker Panel -->
    <div class="history-panel-card" id="qevTrackerCard">
      <div class="history-panel-header" onclick="toggleHistoryPanel('qev')">
        <span class="history-panel-title">üìà QUANT EV LIVE TRACKER</span>
        <span class="history-panel-toggle" id="qevToggleIcon">‚ñº</span>
      </div>
      <div class="history-panel-body" id="qevTrackerPanel">
        <div class="qev-header-info">
          <div class="qev-title-row">
            <span class="qev-round-title" id="qevRoundTitle">TEAMPLAY | Round 0</span>
            <span class="qev-streak" id="qevStreak">Streak: 0</span>
          </div>
          <div class="qev-roles-row" id="qevRolesRow">P1-P2: BS | P3: BOOST | P4: QEV+MG | P5: SAC</div>
        </div>
        <div class="qev-players-table">
          <table class="qev-table" id="qevPlayersTable">
            <thead>
              <tr>
                <th>P</th>
                <th>Bank</th>
                <th>W</th>
                <th>L</th>
                <th>P</th>
                <th>WR%</th>
                <th>Role</th>
              </tr>
            </thead>
            <tbody id="qevTableBody">
              <tr><td>P1</td><td>$100k</td><td>0</td><td>0</td><td>0</td><td>0%</td><td class="role-bs">BS</td></tr>
              <tr><td>P2</td><td>$100k</td><td>0</td><td>0</td><td>0</td><td>0%</td><td class="role-bs">BS</td></tr>
              <tr><td>P3</td><td>$100k</td><td>0</td><td>0</td><td>0</td><td>0%</td><td class="role-boost">BOOST</td></tr>
              <tr><td>P4</td><td>$100k</td><td>0</td><td>0</td><td>0</td><td>0%</td><td class="role-qev">QEV</td></tr>
              <tr><td>P5</td><td>$100k</td><td>0</td><td>0</td><td>0</td><td>0%</td><td class="role-sac">SAC</td></tr>
            </tbody>
          </table>
        </div>
        <div class="qev-round-log" id="qevRoundLog">
          <div class="qev-empty">Round history will appear here</div>
        </div>
      </div>
    </div>

    <!-- Betting History Panel -->
    <div class="history-panel-card" id="bettingHistoryCard">
      <div class="history-panel-header" onclick="toggleHistoryPanel('betting')">
        <span class="history-panel-title">üìä BETTING HISTORY</span>
        <span class="history-panel-toggle" id="bettingHistoryToggleIcon">‚ñº</span>
      </div>
      <div class="history-panel-body" id="bettingHistoryPanel">
        <div class="history-header">
          <span>BETTING HISTORY</span>
          <span id="bettingGameStatus">No Active Game</span>
        </div>
        <div class="history-actions">
          <button onclick="startNewGame(8)" class="btn-small">Start New Game</button>
          <button onclick="exportBettingHistoryCSV()" class="btn-small">Export CSV</button>
        </div>
        <div class="betting-history-list" id="bettingHistoryList">
          <!-- Betting history entries will be added here -->
        </div>
      </div>
    </div>
  </section>

  <!-- Config Page (hidden by default) -->
  <div id="configPage" class="full-page-panel" style="display: none;">
    <div class="config-page-content">
      <div class="config-page-header">
        <h2 class="config-title">Manage Configurations</h2>
        <button class="btn-create-config" id="btnCreateConfig">+ Create New Config</button>
      </div>

      <div class="config-section-label">Existing Configurations (<span id="configCount">2</span>)</div>

      <div class="config-cards-container" id="configCardsContainer">
        <!-- Config cards will be rendered here by JavaScript -->
      </div>

      <!-- Current Room Configuration -->
      <div class="current-room-config">
        <div class="room-config-header">Current Room Configuration</div>
        <div class="room-config-body">
          <span>Active Config: <strong id="activeConfigName">Default</strong></span>
          <span class="room-config-note">All users in this room use the same configuration.</span>
        </div>
      </div>
    </div>
  </div>

  <!-- Players Page (hidden by default) -->
  <div id="playersPage" class="full-page-panel" style="display: none;">
    <div class="players-page-content">
      <div class="players-page-header">
        <h1 class="players-title">Players Management</h1>
        <p class="players-subtitle">View and manage players in the current session</p>
      </div>

      <!-- Current Session Info -->
      <div class="session-info-card">
        <div class="session-info-row">
          <span class="session-label">Current Room:</span>
          <span class="session-value" id="currentRoomName">Not Connected</span>
        </div>
        <div class="session-info-row">
          <span class="session-label">Your Name:</span>
          <span class="session-value" id="currentPlayerName">‚Äî</span>
        </div>
        <div class="session-info-row">
          <span class="session-label">Status:</span>
          <span class="session-value status-badge" id="playerStatus">Offline</span>
        </div>
      </div>

      <!-- Players List -->
      <div class="players-list-section">
        <div class="players-list-header">
          <h2>Players in Room</h2>
          <span class="player-count-badge" id="playerCountBadge">0</span>
        </div>
        <div class="players-list" id="playersList">
          <!-- Players will be rendered here -->
        </div>
      </div>

      <!-- Player Seats -->
      <div class="player-seats-section">
        <h2>Seat Assignments</h2>
        <div class="seats-grid" id="seatsGrid">
          <!-- Seats will be rendered here -->
        </div>
      </div>

      <!-- Player Stats -->
      <div class="player-stats-section">
        <h2>Session Statistics</h2>
        <div class="stats-grid">
          <div class="stat-card">
            <span class="stat-card-value" id="statRoundsPlayed">0</span>
            <span class="stat-card-label">Rounds Played</span>
          </div>
          <div class="stat-card">
            <span class="stat-card-value" id="statPairsWon">0</span>
            <span class="stat-card-label">Pairs Won</span>
          </div>
          <div class="stat-card">
            <span class="stat-card-value" id="statCardsDealt">0</span>
            <span class="stat-card-label">Cards Dealt</span>
          </div>
          <div class="stat-card">
            <span class="stat-card-value" id="statTimeInSession">0m</span>
            <span class="stat-card-label">Time in Session</span>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Rooms Page (hidden by default) -->
  <div id="roomsPage" class="full-page-panel" style="display: none;">
    <div class="rooms-page-content">
      <div class="rooms-header">
        <h1 class="rooms-title">Casino Table Rooms</h1>
        <p class="rooms-subtitle">Join a table to play with other players in real-time</p>
      </div>

      <!-- Your Name Input -->
      <div class="name-input-section">
        <label>Your Name:</label>
        <input type="text" id="playerName" class="player-name-input" placeholder="Enter your name..." value="Player">
      </div>

      <!-- Available Rooms -->
      <div class="rooms-section">
        <div class="rooms-section-header">
          <h2>Available Rooms</h2>
          <button class="btn-refresh-rooms" id="btnRefreshRooms">
            <span class="refresh-icon">‚Üª</span> Refresh
          </button>
        </div>

        <div class="rooms-grid" id="roomsGrid">
          <!-- Room cards will be rendered here by JavaScript -->
        </div>
      </div>

      <!-- How It Works -->
      <div class="how-it-works">
        <h3>How It Works</h3>
        <ol>
          <li>Choose a table room to join</li>
          <li>One player controls the game at a time</li>
          <li>Click "Take Over" to request control</li>
          <li>All players see the same game state in real-time</li>
          <li>Practice card counting together!</li>
        </ol>
      </div>
    </div>
  </div>

  <!-- Create/Edit Config Modal -->
  <div id="configModal" class="modal-overlay" style="display: none;">
    <div class="modal-content config-modal">
      <div class="modal-header">
        <h3 id="configModalTitle">Create New Configuration</h3>
        <button class="btn-close-modal" id="btnCloseConfigModal">&times;</button>
      </div>
      <div class="modal-body">
        <div class="config-form">
          <div class="form-group">
            <label>Configuration Name</label>
            <input type="text" id="configName" placeholder="Enter config name...">
          </div>

          <div class="form-section-title">Table Rules</div>
          <div class="form-row">
            <label>Decks:</label>
            <select id="cfgDecks">
              <option value="1">1</option>
              <option value="2">2</option>
              <option value="4">4</option>
              <option value="6">6</option>
              <option value="8" selected>8</option>
              <option value="16">16</option>
              <option value="32">32</option>
              <option value="64">64</option>
              <option value="100">100</option>
              <option value="200">200</option>
              <option value="300">300</option>
              <option value="400">400</option>
              <option value="500">500</option>
              <option value="600">600</option>
              <option value="700">700</option>
              <option value="800">800</option>
              <option value="900">900</option>
              <option value="1000">1000</option>
            </select>
          </div>
          <div class="form-row">
            <label>Dealer Hits S17:</label>
            <select id="cfgDealerHitsS17">
              <option value="no" selected>No</option>
              <option value="yes">Yes</option>
            </select>
          </div>
          <div class="form-row">
            <label>Double After Split:</label>
            <select id="cfgDoubleAfterSplit">
              <option value="no" selected>No</option>
              <option value="yes">Yes</option>
            </select>
          </div>
          <div class="form-row">
            <label>Surrender:</label>
            <select id="cfgSurrender">
              <option value="no" selected>No</option>
              <option value="yes">Yes</option>
            </select>
          </div>

          <div class="form-section-title">Strategy Options</div>
          <div class="form-row">
            <label>Illustrious 18:</label>
            <select id="cfgIllustrious18">
              <option value="enabled" selected>Enabled</option>
              <option value="disabled">Disabled</option>
            </select>
          </div>
          <div class="form-row">
            <label>Fab 4:</label>
            <select id="cfgFab4">
              <option value="enabled" selected>Enabled</option>
              <option value="disabled">Disabled</option>
            </select>
          </div>
          <div class="form-row">
            <label>Split Any Tens:</label>
            <select id="cfgSplitAnyTens">
              <option value="disabled" selected>Disabled</option>
              <option value="enabled">Enabled</option>
            </select>
          </div>
          <div class="form-row">
            <label>Multi-Split:</label>
            <select id="cfgMultiSplit">
              <option value="disabled" selected>Disabled</option>
              <option value="enabled">Enabled</option>
            </select>
          </div>

          <div class="form-section-title">Betting Limits</div>
          <div class="form-row">
            <label>Max Pooled Bet:</label>
            <input type="number" id="cfgMaxPooledBet" value="50000" min="100" max="1000000" step="100">
          </div>

          <div class="form-section-title">Advanced</div>
          <div class="form-row">
            <label>Enabled Strategies:</label>
            <select id="cfgEnabledStrategies">
              <option value="none">None</option>
              <option value="quant_ev">Quant EV</option>
              <option value="basic">Basic Strategy</option>
              <option value="hi_lo">Hi-Lo Count</option>
              <option value="full">Full Suite</option>
            </select>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn-cancel" id="btnCancelConfig">Cancel</button>
        <button class="btn-save" id="btnSaveConfig">Save Configuration</button>
      </div>
    </div>
  </div>

  <!-- Formula Information Modal -->
  <div id="formulaModal" class="modal-overlay" style="display: none;">
    <div class="modal-content formula-modal">
      <div class="modal-header">
        <h3>Probability Engine - Formulas & Strategy</h3>
        <button class="btn-close-modal" id="btnCloseFormulaModal">&times;</button>
      </div>
      <div class="modal-body">
        <div class="formula-tabs">
          <button class="formula-tab active" data-tab="hilo">Hi-Lo Count</button>
          <button class="formula-tab" data-tab="truecount">True Count</button>
          <button class="formula-tab" data-tab="basic">Basic Strategy</button>
          <button class="formula-tab" data-tab="illustrious">Illustrious 18</button>
          <button class="formula-tab" data-tab="fab4">Fab 4</button>
          <button class="formula-tab" data-tab="advantage">Player Advantage</button>
        </div>
        <div class="formula-content">
          <!-- Hi-Lo Count Section -->
          <div class="formula-section active" id="section-hilo">
            <div class="formula-title">
              <span class="formula-title-icon">+/-</span>
              Hi-Lo Card Counting System
            </div>
            <p class="formula-text">
              The Hi-Lo system is the most widely used card counting method in blackjack. Developed by Harvey Dubner in 1963, it assigns point values to cards to track the ratio of high to low cards remaining in the deck.
            </p>

            <h4 class="formula-subtitle">Card Values</h4>
            <table class="formula-table">
              <tr>
                <th>Cards</th>
                <th>Value</th>
                <th>Significance</th>
              </tr>
              <tr>
                <td>2, 3, 4, 5, 6</td>
                <td style="color: #22c55e; font-weight: bold;">+1</td>
                <td>Low cards favor dealer (dealer must hit to 17)</td>
              </tr>
              <tr>
                <td>7, 8, 9</td>
                <td style="color: #eab308; font-weight: bold;">0</td>
                <td>Neutral - minimal impact on odds</td>
              </tr>
              <tr>
                <td>10, J, Q, K, A</td>
                <td style="color: #ef4444; font-weight: bold;">-1</td>
                <td>High cards favor player (blackjacks, doubles)</td>
              </tr>
            </table>

            <div class="formula-box">
              <div class="formula-label">Running Count Formula</div>
              <code>Running Count = Sum of all card values dealt</code>
            </div>

            <div class="formula-highlight">
              <strong>Key Insight:</strong> A positive count means more high cards remain, giving the player an edge. A negative count means more low cards remain, favoring the dealer.
            </div>

            <h4 class="formula-subtitle">Why It Works</h4>
            <p class="formula-text">
              High cards (10s, Aces) benefit players because:
            </p>
            <ul class="formula-text" style="margin-left: 20px;">
              <li>Blackjacks pay 3:2 (player advantage)</li>
              <li>Better odds on double downs</li>
              <li>Dealer more likely to bust when hitting</li>
              <li>Insurance becomes profitable at high counts</li>
            </ul>
          </div>

          <!-- True Count Section -->
          <div class="formula-section" id="section-truecount">
            <div class="formula-title">
              <span class="formula-title-icon">TC</span>
              True Count Calculation
            </div>
            <p class="formula-text">
              The True Count normalizes the Running Count based on how many decks remain to be dealt. This gives a more accurate measure of the player's advantage regardless of penetration.
            </p>

            <div class="formula-box">
              <div class="formula-label">True Count Formula</div>
              <code>True Count = Running Count / Decks Remaining</code>
            </div>

            <h4 class="formula-subtitle">Example Calculation</h4>
            <table class="formula-table">
              <tr>
                <th>Scenario</th>
                <th>Running Count</th>
                <th>Decks Left</th>
                <th>True Count</th>
              </tr>
              <tr>
                <td>Early in shoe</td>
                <td>+6</td>
                <td>6 decks</td>
                <td>+1.0</td>
              </tr>
              <tr>
                <td>Mid shoe</td>
                <td>+6</td>
                <td>3 decks</td>
                <td>+2.0</td>
              </tr>
              <tr>
                <td>Late in shoe</td>
                <td>+6</td>
                <td>1.5 decks</td>
                <td>+4.0</td>
              </tr>
            </table>

            <div class="formula-highlight">
              <strong>Advantage Correlation:</strong> Each +1 True Count increases player advantage by approximately 0.5%. At TC +2, the player has roughly a 1% edge over the house.
            </div>

            <h4 class="formula-subtitle">Betting Correlation</h4>
            <table class="formula-table">
              <tr>
                <th>True Count</th>
                <th>Player Edge</th>
                <th>Recommended Bet</th>
              </tr>
              <tr>
                <td>TC &le; 0</td>
                <td>House edge</td>
                <td>Minimum bet</td>
              </tr>
              <tr>
                <td>TC +1</td>
                <td>~0% (break even)</td>
                <td>1-2 units</td>
              </tr>
              <tr>
                <td>TC +2</td>
                <td>~0.5-1%</td>
                <td>2-4 units</td>
              </tr>
              <tr>
                <td>TC +3</td>
                <td>~1-1.5%</td>
                <td>4-8 units</td>
              </tr>
              <tr>
                <td>TC +4+</td>
                <td>~1.5-2%+</td>
                <td>8-16 units</td>
              </tr>
            </table>
          </div>

          <!-- Basic Strategy Section -->
          <div class="formula-section" id="section-basic">
            <div class="formula-title">
              <span class="formula-title-icon">BS</span>
              Basic Strategy Matrix
            </div>
            <p class="formula-text">
              Basic Strategy is the mathematically optimal way to play every hand based solely on your cards and the dealer's upcard. It reduces the house edge to approximately 0.5% when followed perfectly.
            </p>

            <h4 class="formula-subtitle">Decision Priority</h4>
            <table class="formula-table">
              <tr>
                <th>Priority</th>
                <th>Decision</th>
                <th>When to Consider</th>
              </tr>
              <tr>
                <td>1</td>
                <td style="color: #a855f7; font-weight: bold;">SURRENDER (R)</td>
                <td>16 vs 9/10/A, 15 vs 10 (if allowed)</td>
              </tr>
              <tr>
                <td>2</td>
                <td style="color: #f59e0b; font-weight: bold;">SPLIT (P)</td>
                <td>Pairs - Always split A-A, 8-8; Never split 10-10, 5-5</td>
              </tr>
              <tr>
                <td>3</td>
                <td style="color: #ef4444; font-weight: bold;">DOUBLE (D)</td>
                <td>11 vs 2-10, 10 vs 2-9, Soft 13-17 vs 5-6</td>
              </tr>
              <tr>
                <td>4</td>
                <td style="color: #22c55e; font-weight: bold;">HIT (H) / STAND (S)</td>
                <td>All remaining situations</td>
              </tr>
            </table>

            <h4 class="formula-subtitle">Hard Totals Quick Reference</h4>
            <div class="formula-highlight">
              <strong>Hard 17+:</strong> Always Stand<br>
              <strong>Hard 13-16:</strong> Stand vs 2-6, Hit vs 7-A<br>
              <strong>Hard 12:</strong> Stand vs 4-6, Hit vs 2-3 and 7-A<br>
              <strong>Hard 11:</strong> Always Double (Hit vs A in some rules)<br>
              <strong>Hard 10:</strong> Double vs 2-9, Hit vs 10-A<br>
              <strong>Hard 9:</strong> Double vs 3-6, Hit otherwise<br>
              <strong>Hard 8 or less:</strong> Always Hit
            </div>

            <h4 class="formula-subtitle">Soft Totals Quick Reference</h4>
            <div class="formula-highlight">
              <strong>Soft 20 (A-9):</strong> Always Stand<br>
              <strong>Soft 19 (A-8):</strong> Stand (Double vs 6 in some variants)<br>
              <strong>Soft 18 (A-7):</strong> Stand vs 2,7,8; Double vs 3-6; Hit vs 9-A<br>
              <strong>Soft 17 (A-6):</strong> Double vs 3-6, Hit otherwise<br>
              <strong>Soft 13-16:</strong> Double vs 5-6, Hit otherwise
            </div>
          </div>

          <!-- Illustrious 18 Section -->
          <div class="formula-section" id="section-illustrious">
            <div class="formula-title">
              <span class="formula-title-icon">I18</span>
              Illustrious 18 Deviations
            </div>
            <p class="formula-text">
              The Illustrious 18 are the most valuable index plays that deviate from Basic Strategy based on the True Count. Developed by Don Schlesinger, these 18 plays capture approximately 80% of the gain available from using indices.
            </p>

            <h4 class="formula-subtitle">Top 18 Index Plays (Ranked by Value)</h4>
            <table class="formula-table">
              <tr>
                <th>#</th>
                <th>Hand</th>
                <th>Dealer</th>
                <th>Index</th>
                <th>Deviation</th>
              </tr>
              <tr>
                <td>1</td>
                <td>Insurance</td>
                <td>A</td>
                <td>TC +3</td>
                <td>Take insurance when TC >= +3</td>
              </tr>
              <tr>
                <td>2</td>
                <td>16</td>
                <td>10</td>
                <td>TC 0</td>
                <td>Stand at TC >= 0 (normally hit)</td>
              </tr>
              <tr>
                <td>3</td>
                <td>15</td>
                <td>10</td>
                <td>TC +4</td>
                <td>Stand at TC >= +4</td>
              </tr>
              <tr>
                <td>4</td>
                <td>10,10</td>
                <td>5</td>
                <td>TC +5</td>
                <td>Split tens at TC >= +5</td>
              </tr>
              <tr>
                <td>5</td>
                <td>10,10</td>
                <td>6</td>
                <td>TC +4</td>
                <td>Split tens at TC >= +4</td>
              </tr>
              <tr>
                <td>6</td>
                <td>10</td>
                <td>10</td>
                <td>TC +4</td>
                <td>Double at TC >= +4</td>
              </tr>
              <tr>
                <td>7</td>
                <td>12</td>
                <td>3</td>
                <td>TC +2</td>
                <td>Stand at TC >= +2</td>
              </tr>
              <tr>
                <td>8</td>
                <td>12</td>
                <td>2</td>
                <td>TC +3</td>
                <td>Stand at TC >= +3</td>
              </tr>
              <tr>
                <td>9</td>
                <td>11</td>
                <td>A</td>
                <td>TC +1</td>
                <td>Double at TC >= +1</td>
              </tr>
              <tr>
                <td>10</td>
                <td>9</td>
                <td>2</td>
                <td>TC +1</td>
                <td>Double at TC >= +1</td>
              </tr>
            </table>

            <div class="formula-highlight">
              <strong>Reading the Index:</strong> When the True Count reaches or exceeds the index number, deviate from Basic Strategy. For example, with 16 vs 10, Basic Strategy says Hit. But at TC >= 0, you should Stand instead.
            </div>
          </div>

          <!-- Fab 4 Section -->
          <div class="formula-section" id="section-fab4">
            <div class="formula-title">
              <span class="formula-title-icon">F4</span>
              Fab 4 Surrender Indices
            </div>
            <p class="formula-text">
              The Fab 4 are the four most important surrender indices when late surrender is available. These plays are highly valuable because surrender saves half your bet in situations with very poor odds.
            </p>

            <h4 class="formula-subtitle">The Four Key Surrender Plays</h4>
            <table class="formula-table">
              <tr>
                <th>Hand</th>
                <th>vs Dealer</th>
                <th>Index</th>
                <th>Action</th>
              </tr>
              <tr>
                <td style="font-weight: bold;">14</td>
                <td>10</td>
                <td>TC +3</td>
                <td>Surrender at TC >= +3</td>
              </tr>
              <tr>
                <td style="font-weight: bold;">15</td>
                <td>10</td>
                <td>TC 0</td>
                <td>Surrender at TC >= 0 (always)</td>
              </tr>
              <tr>
                <td style="font-weight: bold;">15</td>
                <td>A</td>
                <td>TC +1</td>
                <td>Surrender at TC >= +1</td>
              </tr>
              <tr>
                <td style="font-weight: bold;">15</td>
                <td>9</td>
                <td>TC +2</td>
                <td>Surrender at TC >= +2</td>
              </tr>
            </table>

            <h4 class="formula-subtitle">Why Surrender Matters</h4>
            <div class="formula-highlight">
              <strong>Expected Value:</strong> When you surrender, you lose exactly 50% of your bet. If your expected loss by playing the hand exceeds 50%, surrender is the mathematically correct play.
            </div>

            <p class="formula-text">
              At high True Counts, the deck is rich in 10s, making the dealer more likely to have a pat hand (17-21) and more likely to make 20 or 21 specifically. Your stiff hands (14-16) become even more dangerous to hit.
            </p>

            <div class="formula-box">
              <div class="formula-label">Surrender Break-Even</div>
              <code>Surrender when: Win% &lt; 25% (or Loss% &gt; 75%)</code>
            </div>
          </div>

          <!-- Player Advantage Section -->
          <div class="formula-section" id="section-advantage">
            <div class="formula-title">
              <span class="formula-title-icon">%</span>
              Player Advantage Calculation
            </div>
            <p class="formula-text">
              Understanding your edge helps make optimal betting decisions. The player's advantage shifts based on the True Count, game rules, and penetration.
            </p>

            <div class="formula-box">
              <div class="formula-label">Player Advantage Formula</div>
              <code>Advantage = Base Edge + (True Count x 0.5%)</code>
            </div>

            <h4 class="formula-subtitle">Base House Edge by Rules</h4>
            <table class="formula-table">
              <tr>
                <th>Rule Variation</th>
                <th>Effect on Edge</th>
              </tr>
              <tr>
                <td>8 decks vs 1 deck</td>
                <td>+0.6% house edge</td>
              </tr>
              <tr>
                <td>Dealer hits soft 17</td>
                <td>+0.2% house edge</td>
              </tr>
              <tr>
                <td>No double after split</td>
                <td>+0.14% house edge</td>
              </tr>
              <tr>
                <td>No surrender</td>
                <td>+0.08% house edge</td>
              </tr>
              <tr>
                <td>Blackjack pays 6:5</td>
                <td>+1.4% house edge</td>
              </tr>
            </table>

            <h4 class="formula-subtitle">Advantage Visualization</h4>
            <div class="advantage-meter">
              <span>-2%</span>
              <div class="advantage-bar">
                <div class="advantage-marker" style="left: 50%;"></div>
              </div>
              <span>+2%</span>
            </div>
            <div class="advantage-labels">
              <span>House Edge</span>
              <span>Neutral</span>
              <span>Player Edge</span>
            </div>

            <div class="formula-highlight">
              <strong>Kelly Criterion:</strong> Bet a percentage of your bankroll equal to your edge divided by the variance. For blackjack, a simplified approach is: Bet Units = True Count - 1 (for TC > 1).
            </div>

            <h4 class="formula-subtitle">Expected Value Per Hand</h4>
            <p class="formula-text">
              With a 1% edge and $100 average bet:<br>
              <strong>EV = $100 x 1% = $1.00 per hand</strong><br><br>
              At 100 hands/hour: <strong>$100/hour expected profit</strong>
            </p>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Game History Modal -->
  <div id="historyModal" class="modal-overlay history-modal" onclick="if(event.target === this) hideHistoryPanel()">
    <div class="modal-content history-modal-content">
      <div class="modal-header">
        <h2>Game History & Analytics</h2>
        <button class="btn-close-modal" onclick="hideHistoryPanel()">&times;</button>
      </div>
      <div class="modal-body history-body">
        <!-- Statistics Grid -->
        <div class="hist-stats-grid">
          <div class="hist-stat-box">
            <span class="hist-stat-label">Rounds</span>
            <span class="hist-stat-value" id="histRounds">0</span>
          </div>
          <div class="hist-stat-box">
            <span class="hist-stat-label">Wins</span>
            <span class="hist-stat-value green" id="histWins">0</span>
          </div>
          <div class="hist-stat-box">
            <span class="hist-stat-label">Losses</span>
            <span class="hist-stat-value red" id="histLosses">0</span>
          </div>
          <div class="hist-stat-box">
            <span class="hist-stat-label">Win Rate</span>
            <span class="hist-stat-value" id="histWinRate">0%</span>
          </div>
          <div class="hist-stat-box">
            <span class="hist-stat-label">Dealer Busts</span>
            <span class="hist-stat-value green" id="histDealerBusts">0</span>
          </div>
          <div class="hist-stat-box">
            <span class="hist-stat-label">D. Bust Rate</span>
            <span class="hist-stat-value" id="histDealerBustRate">0%</span>
          </div>
          <div class="hist-stat-box">
            <span class="hist-stat-label">Player Busts</span>
            <span class="hist-stat-value red" id="histPlayerBusts">0</span>
          </div>
          <div class="hist-stat-box">
            <span class="hist-stat-label">Blackjacks</span>
            <span class="hist-stat-value gold" id="histBlackjacks">0</span>
          </div>
          <div class="hist-stat-box">
            <span class="hist-stat-label">Splits</span>
            <span class="hist-stat-value" id="histSplits">0</span>
          </div>
          <div class="hist-stat-box">
            <span class="hist-stat-label">Doubles</span>
            <span class="hist-stat-value" id="histDoubles">0</span>
          </div>
          <div class="hist-stat-box">
            <span class="hist-stat-label">Duration</span>
            <span class="hist-stat-value" id="histDuration">0 min</span>
          </div>
        </div>

        <!-- Alerts Section -->
        <div class="hist-section">
          <h3 class="hist-section-title">Alerts & Patterns</h3>
          <div class="hist-alerts-list" id="histAlertsList">
            <div class="hist-alert-item">No alerts yet</div>
          </div>
        </div>

        <!-- Recent Rounds Section -->
        <div class="hist-section">
          <h3 class="hist-section-title">Recent Rounds</h3>
          <div class="hist-rounds-list" id="histRoundsList">
            <div class="hist-round-item">No rounds recorded</div>
          </div>
        </div>

        <!-- Export Section -->
        <div class="hist-export-section">
          <h3 class="hist-section-title">Export History</h3>
          <div class="hist-export-buttons">
            <button class="btn-export" onclick="exportGameHistory('json')">
              Export JSON
            </button>
            <button class="btn-export" onclick="exportGameHistory('csv')">
              Export CSV
            </button>
            <button class="btn-export btn-export-report" onclick="exportGameHistory('report')">
              Export Report
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Hand Analyzer Modal -->
  <div id="handAnalyzerModal" class="modal-overlay" style="display: none;" onclick="if(event.target === this) closeHandAnalyzer()">
    <div class="modal-content analyzer-modal">
      <div class="modal-header">
        <h2>Hand Analyzer</h2>
        <button class="btn-close-modal" onclick="closeHandAnalyzer()">&times;</button>
      </div>
      <div class="modal-body">
        <div class="analyzer-inputs">
          <div class="input-group">
            <label>Player Hand (e.g., "10,6" or "A,7")</label>
            <input type="text" id="analyzerPlayerHand" placeholder="Enter cards...">
          </div>
          <div class="input-group">
            <label>Dealer Upcard</label>
            <select id="analyzerDealerCard">
              <option value="2">2</option>
              <option value="3">3</option>
              <option value="4">4</option>
              <option value="5">5</option>
              <option value="6">6</option>
              <option value="7">7</option>
              <option value="8">8</option>
              <option value="9">9</option>
              <option value="10">10</option>
              <option value="A">A</option>
            </select>
          </div>
          <button class="btn-analyze" onclick="runHandAnalysis()">Analyze Hand</button>
        </div>
        <div id="analyzerResults" class="analyzer-results">
          <div class="result-placeholder">Enter a hand to see EV analysis</div>
        </div>
      </div>
    </div>
  </div>

  <!-- Risk of Ruin Modal -->
  <div id="rorModal" class="modal-overlay" style="display: none;" onclick="if(event.target === this) closeRoRCalculator()">
    <div class="modal-content ror-modal">
      <div class="modal-header">
        <h2>Risk of Ruin Calculator</h2>
        <button class="btn-close-modal" onclick="closeRoRCalculator()">&times;</button>
      </div>
      <div class="modal-body">
        <div class="ror-inputs">
          <div class="input-row">
            <label>Bankroll ($)</label>
            <input type="number" id="rorBankroll" value="10000" min="100">
          </div>
          <div class="input-row">
            <label>Bet Unit ($)</label>
            <input type="number" id="rorBetUnit" value="100" min="1">
          </div>
          <div class="input-row">
            <label>Player Advantage (%)</label>
            <input type="number" id="rorAdvantage" value="1.0" step="0.1">
          </div>
          <div class="input-row">
            <label>Std Deviation</label>
            <input type="number" id="rorStdDev" value="1.15" step="0.01">
          </div>
          <button class="btn-calculate" onclick="calculateRoR()">Calculate Risk</button>
        </div>
        <div id="rorResults" class="ror-results"></div>
      </div>
    </div>
  </div>

  <!-- Variance Calculator Modal -->
  <div id="varianceModal" class="modal-overlay" style="display: none;" onclick="if(event.target === this) closeVarianceCalculator()">
    <div class="modal-content variance-modal">
      <div class="modal-header">
        <h2>Variance Calculator</h2>
        <button class="btn-close-modal" onclick="closeVarianceCalculator()">&times;</button>
      </div>
      <div class="modal-body">
        <div class="variance-inputs">
          <div class="input-row">
            <label>Number of Hands</label>
            <input type="number" id="varHands" value="1000" min="1">
          </div>
          <div class="input-row">
            <label>Bet Size ($)</label>
            <input type="number" id="varBetSize" value="100" min="1">
          </div>
          <div class="input-row">
            <label>Player Advantage (%)</label>
            <input type="number" id="varAdvantage" value="1.0" step="0.1">
          </div>
          <button class="btn-calculate" onclick="calculateVariance()">Calculate Variance</button>
        </div>
        <div id="varianceResults" class="variance-results"></div>
      </div>
    </div>
  </div>

  <!-- Training Mode Modal -->
  <div id="trainingModal" class="modal-overlay" style="display: none;" onclick="if(event.target === this) closeTrainingMode()">
    <div class="modal-content training-modal">
      <div class="modal-header">
        <h2>Training Mode</h2>
        <button class="btn-close-modal" onclick="closeTrainingMode()">&times;</button>
      </div>
      <div class="modal-body">
        <div class="training-stats">
          <div class="stat-item">
            <span class="stat-label">Score</span>
            <span id="trainingScore" class="stat-value">0/0</span>
          </div>
          <div class="stat-item">
            <span class="stat-label">Streak</span>
            <span id="trainingStreak" class="stat-value">0</span>
          </div>
          <div class="stat-item">
            <span class="stat-label">Accuracy</span>
            <span id="trainingAccuracy" class="stat-value">0%</span>
          </div>
        </div>
        <div id="trainingHand" class="training-hand">
          <div class="training-scenario">
            <div class="dealer-card-display">
              <span class="card-label">Dealer Shows</span>
              <span id="trainingDealer" class="big-card">?</span>
            </div>
            <div class="player-hand-display">
              <span class="card-label">Your Hand</span>
              <span id="trainingPlayer" class="big-hand">? + ?</span>
              <span id="trainingTotal" class="hand-total">(0)</span>
            </div>
            <div id="trainingTC" class="training-tc">TC: 0</div>
          </div>
        </div>
        <div class="training-options">
          <button class="btn-training-option" onclick="checkTrainingAnswer('H')">HIT</button>
          <button class="btn-training-option" onclick="checkTrainingAnswer('S')">STAND</button>
          <button class="btn-training-option" onclick="checkTrainingAnswer('D')">DOUBLE</button>
          <button class="btn-training-option" onclick="checkTrainingAnswer('P')">SPLIT</button>
          <button class="btn-training-option" onclick="checkTrainingAnswer('R')">SURRENDER</button>
        </div>
        <div id="trainingFeedback" class="training-feedback"></div>
        <button class="btn-next-hand" onclick="generateTrainingHand()">Next Hand</button>
      </div>
    </div>
  </div>

  <!-- Session Tracker Modal -->
  <div id="sessionTrackerModal" class="modal-overlay" style="display: none;" onclick="if(event.target === this) closeSessionTracker()">
    <div class="modal-content session-modal">
      <div class="modal-header">
        <h2>Session Bankroll Tracker</h2>
        <button class="btn-close-modal" onclick="closeSessionTracker()">&times;</button>
      </div>
      <div class="modal-body">
        <div class="session-bankroll-display">
          <div class="bankroll-main">
            <span class="bankroll-label">Current Bankroll</span>
            <span id="sessionCurrentBankroll" class="bankroll-value">$1,000</span>
          </div>
          <div class="bankroll-change" id="sessionPnL">+$0 (0%)</div>
        </div>
        <div class="session-stats-grid">
          <div class="session-stat">
            <span class="stat-label">Starting</span>
            <span id="sessionStartBankroll" class="stat-value">$1,000</span>
          </div>
          <div class="session-stat">
            <span class="stat-label">Peak</span>
            <span id="sessionPeak" class="stat-value">$1,000</span>
          </div>
          <div class="session-stat">
            <span class="stat-label">Lowest</span>
            <span id="sessionLowest" class="stat-value">$1,000</span>
          </div>
          <div class="session-stat">
            <span class="stat-label">Hands</span>
            <span id="sessionHands" class="stat-value">0</span>
          </div>
          <div class="session-stat">
            <span class="stat-label">Win Rate</span>
            <span id="sessionWinRate" class="stat-value">0%</span>
          </div>
          <div class="session-stat">
            <span class="stat-label">Duration</span>
            <span id="sessionDuration" class="stat-value">0:00</span>
          </div>
        </div>
        <div class="session-controls">
          <div class="input-row">
            <label>Set Bankroll ($)</label>
            <input type="number" id="sessionBankrollInput" value="1000" min="0">
            <button onclick="updateSessionBankroll()">Update</button>
          </div>
          <div class="session-buttons">
            <button class="btn-session" onclick="resetSession()">Reset Session</button>
            <button class="btn-session" onclick="exportSessionData()">Export Data</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Bet Spread Optimizer Modal -->
  <div id="betOptimizerModal" class="modal-overlay" style="display: none;" onclick="if(event.target === this) closeBetOptimizer()">
    <div class="modal-content optimizer-modal">
      <div class="modal-header">
        <h2>Bet Spread Optimizer</h2>
        <button class="btn-close-modal" onclick="closeBetOptimizer()">&times;</button>
      </div>
      <div class="modal-body">
        <div class="optimizer-inputs">
          <div class="input-row">
            <label>Bankroll ($)</label>
            <input type="number" id="optBankroll" value="10000" min="100">
          </div>
          <div class="input-row">
            <label>Min Bet ($)</label>
            <input type="number" id="optMinBet" value="25" min="1">
          </div>
          <div class="input-row">
            <label>Max Spread</label>
            <select id="optMaxSpread">
              <option value="4">1-4</option>
              <option value="8" selected>1-8</option>
              <option value="12">1-12</option>
              <option value="16">1-16</option>
            </select>
          </div>
          <div class="input-row">
            <label>Risk Tolerance</label>
            <select id="optRiskLevel">
              <option value="conservative">Conservative</option>
              <option value="moderate" selected>Moderate</option>
              <option value="aggressive">Aggressive</option>
            </select>
          </div>
          <button class="btn-calculate" onclick="optimizeBetSpread()">Optimize Spread</button>
        </div>
        <div id="optimizerResults" class="optimizer-results"></div>
      </div>
    </div>
  </div>

  <!-- Count Systems Modal -->
  <div id="countSystemsModal" class="modal-overlay" style="display: none;" onclick="if(event.target === this) closeCountSystems()">
    <div class="modal-content counts-modal">
      <div class="modal-header">
        <h2>Multi-Count Systems</h2>
        <button class="btn-close-modal" onclick="closeCountSystems()">&times;</button>
      </div>
      <div class="modal-body">
        <div class="count-systems-grid">
          <div class="count-system-card">
            <div class="system-name">Hi-Lo</div>
            <div class="system-counts">
              <span id="countHiLo" class="system-rc">RC: 0</span>
              <span id="countHiLoTC" class="system-tc">TC: 0.00</span>
            </div>
            <div class="system-tags">A=-1, 2-6=+1, 7-9=0, T=-1</div>
          </div>
          <div class="count-system-card">
            <div class="system-name">Omega II</div>
            <div class="system-counts">
              <span id="countOmega" class="system-rc">RC: 0</span>
              <span id="countOmegaTC" class="system-tc">TC: 0.00</span>
            </div>
            <div class="system-tags">Level 2, Balanced</div>
          </div>
          <div class="count-system-card">
            <div class="system-name">Hi-Opt II</div>
            <div class="system-counts">
              <span id="countHiOpt" class="system-rc">RC: 0</span>
              <span id="countHiOptTC" class="system-tc">TC: 0.00</span>
            </div>
            <div class="system-tags">Level 2, +Ace side count</div>
          </div>
          <div class="count-system-card">
            <div class="system-name">Zen Count</div>
            <div class="system-counts">
              <span id="countZen" class="system-rc">RC: 0</span>
              <span id="countZenTC" class="system-tc">TC: 0.00</span>
            </div>
            <div class="system-tags">Level 2, Balanced</div>
          </div>
          <div class="count-system-card">
            <div class="system-name">Wong Halves</div>
            <div class="system-counts">
              <span id="countWong" class="system-rc">RC: 0</span>
              <span id="countWongTC" class="system-tc">TC: 0.00</span>
            </div>
            <div class="system-tags">Level 3, Fractional</div>
          </div>
        </div>
        <div class="count-legend">
          <h4>Card Values Reference</h4>
          <table class="count-table">
            <tr>
              <th>Card</th><th>Hi-Lo</th><th>Omega II</th><th>Hi-Opt II</th><th>Zen</th><th>Wong</th>
            </tr>
            <tr><td>2</td><td>+1</td><td>+1</td><td>+1</td><td>+1</td><td>+0.5</td></tr>
            <tr><td>3</td><td>+1</td><td>+1</td><td>+1</td><td>+1</td><td>+1</td></tr>
            <tr><td>4</td><td>+1</td><td>+2</td><td>+2</td><td>+2</td><td>+1</td></tr>
            <tr><td>5</td><td>+1</td><td>+2</td><td>+2</td><td>+2</td><td>+1.5</td></tr>
            <tr><td>6</td><td>+1</td><td>+2</td><td>+1</td><td>+2</td><td>+1</td></tr>
            <tr><td>7</td><td>0</td><td>+1</td><td>+1</td><td>+1</td><td>+0.5</td></tr>
            <tr><td>8</td><td>0</td><td>0</td><td>0</td><td>0</td><td>0</td></tr>
            <tr><td>9</td><td>0</td><td>-1</td><td>0</td><td>0</td><td>-0.5</td></tr>
            <tr><td>10</td><td>-1</td><td>-2</td><td>-2</td><td>-2</td><td>-1</td></tr>
            <tr><td>A</td><td>-1</td><td>0</td><td>0</td><td>-1</td><td>-1</td></tr>
          </table>
        </div>
      </div>
    </div>
  </div>

  <!-- Ace Sequencing Modal -->
  <div id="aceSequencerModal" class="modal-overlay" style="display: none;" onclick="if(event.target === this) closeAceSequencer()">
    <div class="modal-content ace-modal">
      <div class="modal-header">
        <h2>Ace Sequencing Tracker</h2>
        <button class="btn-close-modal" onclick="closeAceSequencer()">&times;</button>
      </div>
      <div class="modal-body">
        <div class="ace-stats">
          <div class="ace-stat">
            <span class="stat-label">Aces Remaining</span>
            <span id="acesRemaining" class="stat-value">32</span>
          </div>
          <div class="ace-stat">
            <span class="stat-label">Expected per Deck</span>
            <span id="aceExpected" class="stat-value">4.0</span>
          </div>
          <div class="ace-stat">
            <span class="stat-label">Ace Richness</span>
            <span id="aceRichness" class="stat-value">1.00x</span>
          </div>
        </div>
        <div class="ace-sequence">
          <h4>Recent Ace Appearances</h4>
          <div id="aceSequenceList" class="sequence-list">
            <span class="no-data">No aces tracked yet</span>
          </div>
        </div>
        <div class="ace-prediction">
          <h4>Ace Probability Next Hand</h4>
          <div id="aceProbability" class="probability-display">7.7%</div>
        </div>
      </div>
    </div>
  </div>

  <!-- Heat Index Modal -->
  <div id="heatIndexModal" class="modal-overlay" style="display: none;" onclick="if(event.target === this) closeHeatIndex()">
    <div class="modal-content heat-modal">
      <div class="modal-header">
        <h2>Heat Index & Camouflage</h2>
        <button class="btn-close-modal" onclick="closeHeatIndex()">&times;</button>
      </div>
      <div class="modal-body">
        <div class="heat-meter">
          <div class="heat-label">Current Heat Level</div>
          <div class="heat-bar-container">
            <div id="heatBar" class="heat-bar" style="width: 20%"></div>
          </div>
          <div class="heat-scale">
            <span>Cool</span>
            <span>Warm</span>
            <span>Hot</span>
            <span>Burning</span>
          </div>
        </div>
        <div class="heat-factors">
          <h4>Heat Factors</h4>
          <div id="heatFactorsList" class="factors-list">
            <div class="factor-item">
              <span class="factor-name">Bet Spread</span>
              <span id="heatSpread" class="factor-value">1:1 (Low)</span>
            </div>
            <div class="factor-item">
              <span class="factor-name">Session Duration</span>
              <span id="heatDuration" class="factor-value">0 min</span>
            </div>
            <div class="factor-item">
              <span class="factor-name">Win Rate</span>
              <span id="heatWinRate" class="factor-value">Normal</span>
            </div>
          </div>
        </div>
        <div class="camouflage-tips">
          <h4>Camouflage Recommendations</h4>
          <ul id="camoTipsList">
            <li>Vary bet sizes slightly even at the same count</li>
            <li>Occasionally make "wrong" plays at low stakes</li>
            <li>Take breaks and change tables periodically</li>
          </ul>
        </div>
      </div>
    </div>
  </div>

  <!-- Wonging Signals Modal -->
  <div id="wongingModal" class="modal-overlay" style="display: none;" onclick="if(event.target === this) closeWonging()">
    <div class="modal-content wonging-modal">
      <div class="modal-header">
        <h2>Wonging Entry/Exit Signals</h2>
        <button class="btn-close-modal" onclick="closeWonging()">&times;</button>
      </div>
      <div class="modal-body">
        <div class="wonging-status">
          <div id="wongingSignal" class="signal-display signal-neutral">
            <span class="signal-icon">‚è∏</span>
            <span class="signal-text">NEUTRAL</span>
          </div>
        </div>
        <div class="wonging-settings">
          <div class="input-row">
            <label>Entry TC Threshold</label>
            <input type="number" id="wongEntry" value="2" min="0" step="0.5">
          </div>
          <div class="input-row">
            <label>Exit TC Threshold</label>
            <input type="number" id="wongExit" value="0" step="0.5">
          </div>
          <button onclick="updateWongingSettings()">Update Settings</button>
        </div>
        <div class="wonging-stats">
          <h4>Session Statistics</h4>
          <div class="wong-stat">
            <span>Entry Opportunities</span>
            <span id="wongEntries">0</span>
          </div>
          <div class="wong-stat">
            <span>Exit Signals</span>
            <span id="wongExits">0</span>
          </div>
          <div class="wong-stat">
            <span>Current TC</span>
            <span id="wongCurrentTC">0.00</span>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Shoe Replay Modal -->
  <div id="shoeReplayModal" class="modal-overlay" style="display: none;" onclick="if(event.target === this) closeShoeReplay()">
    <div class="modal-content replay-modal">
      <div class="modal-header">
        <h2>Shoe Replay</h2>
        <button class="btn-close-modal" onclick="closeShoeReplay()">&times;</button>
      </div>
      <div class="modal-body">
        <div class="replay-controls">
          <button class="btn-replay" onclick="replayPrevRound()">‚èÆ Prev</button>
          <button class="btn-replay" onclick="toggleReplayPause()">‚èØ Play/Pause</button>
          <button class="btn-replay" onclick="replayNextRound()">Next ‚è≠</button>
        </div>
        <div class="replay-progress">
          <span id="replayRoundNum">Round 0</span>
          <input type="range" id="replaySlider" min="0" max="100" value="0" onchange="seekReplay(this.value)">
          <span id="replayTotalRounds">of 0</span>
        </div>
        <div class="replay-display">
          <div class="replay-hand">
            <span class="replay-label">Dealer</span>
            <span id="replayDealer" class="replay-cards">-</span>
          </div>
          <div class="replay-hand">
            <span class="replay-label">Player</span>
            <span id="replayPlayer" class="replay-cards">-</span>
          </div>
          <div class="replay-info">
            <span id="replayDecision">-</span>
            <span id="replayOutcome">-</span>
            <span id="replayTC">TC: 0</span>
          </div>
        </div>
        <div class="replay-list">
          <h4>Saved Shoes</h4>
          <div id="savedShoesList" class="shoes-list">
            <span class="no-data">No saved shoes</span>
          </div>
        </div>
        <button class="btn-save-shoe" onclick="saveCurrentShoe()">Save Current Shoe</button>
      </div>
    </div>
  </div>

  <!-- Live Stream Card Tracker Modal -->
  <div id="videoTrackerModal" class="modal-overlay" style="display: none;" onclick="if(event.target === this) closeVideoTracker()">
    <div class="modal-content live-tracker-modal">
      <div class="modal-header live-tracker-header">
        <h2>Live Stream Card Tracker</h2>
        <div class="live-indicator" id="liveIndicator">
          <span class="live-dot"></span>
          <span>LIVE</span>
        </div>
        <button class="btn-close-modal" onclick="closeVideoTracker()">&times;</button>
      </div>

      <div class="modal-body live-tracker-body">
        <!-- Left Panel: Video/Stream -->
        <div class="stream-panel">
          <div class="source-tabs">
            <button class="source-tab active" onclick="switchStreamSource('screen')" id="tabScreen">Screen Capture</button>
            <button class="source-tab" onclick="switchStreamSource('file')" id="tabFile">Video File</button>
          </div>

          <div class="stream-container">
            <video id="trackerVideo" class="tracker-video" autoplay playsinline></video>
            <canvas id="aiDetectionCanvas" class="ai-detection-canvas"></canvas>
            <canvas id="streamCanvas" class="stream-canvas" style="display:none;"></canvas>
            <div class="stream-overlay" id="streamOverlay">
              <div class="overlay-content">
                <div class="overlay-icon">üì∫</div>
                <div class="overlay-text">Click "Start Capture" to begin</div>
                <div class="overlay-hint">Capture a live casino stream or load a recorded video</div>
              </div>
            </div>
            <!-- AI Detection Status Overlay -->
            <div class="ai-status-overlay" id="aiStatusOverlay">
              <div class="ai-status-badge" id="aiStatusBadge">
                <span class="ai-pulse"></span>
                <span class="ai-status-text">AI READY</span>
              </div>
              <div class="ai-fps" id="aiFPS">0 FPS</div>
            </div>
          </div>

          <!-- AI Detection Controls -->
          <div class="ai-control-panel" id="aiControlPanel">
            <div class="ai-panel-header">
              <span class="ai-icon">ü§ñ</span>
              <span class="ai-title">AI Card Detection</span>
              <div class="ai-mode-toggle">
                <button class="ai-mode-btn active" onclick="setAIMode('auto')" id="btnAIModeAuto">Auto</button>
                <button class="ai-mode-btn" onclick="setAIMode('manual')" id="btnAIModeManual">Manual</button>
              </div>
            </div>
            <div class="ai-controls">
              <button class="btn-ai primary" onclick="startAIDetection()" id="btnStartAI">
                <span class="btn-icon">‚ñ∂</span> Start AI Detection
              </button>
              <button class="btn-ai danger" onclick="stopAIDetection()" id="btnStopAI" style="display:none;">
                <span class="btn-icon">‚èπ</span> Stop AI
              </button>
              <div class="ai-settings">
                <div class="ai-setting">
                  <label>Confidence:</label>
                  <input type="range" id="aiConfidence" min="50" max="95" value="75" onchange="updateAIConfidence(this.value)">
                  <span id="aiConfidenceValue">75%</span>
                </div>
                <div class="ai-setting">
                  <label>Detection Speed:</label>
                  <select id="aiDetectionSpeed" onchange="updateAISpeed(this.value)">
                    <option value="100">Fast (10 FPS)</option>
                    <option value="200" selected>Normal (5 FPS)</option>
                    <option value="500">Slow (2 FPS)</option>
                  </select>
                </div>
                <div class="ai-setting">
                  <label>Debug Grid:</label>
                  <input type="checkbox" id="aiDebugMode" onchange="toggleAIDebugMode(this.checked)">
                </div>
              </div>
            </div>

            <!-- SINGLE ZONE DEALING SEQUENCE -->
            <div class="dealing-sequence-panel">
              <div class="dealing-header">
                <span>üéØ Single Zone Mode</span>
                <span class="dealing-badge">FOCUSED</span>
              </div>
              <div class="dealing-controls">
                <div class="dealing-setting">
                  <label>Players:</label>
                  <select id="numPlayersSelect" onchange="setNumPlayers(parseInt(this.value))">
                    <option value="1">1 Player</option>
                    <option value="2">2 Players</option>
                    <option value="3" selected>3 Players</option>
                    <option value="4">4 Players</option>
                    <option value="5">5 Players</option>
                    <option value="6">6 Players</option>
                    <option value="7">7 Players</option>
                  </select>
                </div>
                <button class="btn-new-hand" onclick="resetDealingSequence()">üîÑ New Hand</button>
              </div>
              <div class="zone-adjust">
                <span class="zone-label">Zone Position:</span>
                <button class="zone-btn" onclick="adjustZone('left')" title="Move Left">‚óÄ</button>
                <button class="zone-btn" onclick="adjustZone('right')" title="Move Right">‚ñ∂</button>
                <button class="zone-btn" onclick="adjustZone('up')" title="Move Up">‚ñ≤</button>
                <button class="zone-btn" onclick="adjustZone('down')" title="Move Down">‚ñº</button>
                <button class="zone-btn" onclick="toggleZonePreview()" title="Show Zone">üëÅ</button>
              </div>
              <div class="dealing-status">
                <div class="dealing-position">
                  <span class="label">Next Card ‚Üí</span>
                  <span class="deal-position player-turn" id="currentDealPosition">P1</span>
                </div>
                <div class="dealing-round">
                  <span class="label">Round:</span>
                  <span id="currentDealRound">Round 1</span>
                </div>
              </div>
              <div class="dealing-sequence-visual" id="dealingSequenceVisual">
                <span class="seq-item active">P1</span>
                <span class="seq-arrow">‚Üí</span>
                <span class="seq-item">P2</span>
                <span class="seq-arrow">‚Üí</span>
                <span class="seq-item">P3</span>
                <span class="seq-arrow">‚Üí</span>
                <span class="seq-item dealer">D</span>
              </div>
            </div>

            <div class="ai-stats">
              <div class="ai-stat">
                <span class="ai-stat-label">Cards Detected</span>
                <span class="ai-stat-value" id="aiCardsDetected">0</span>
              </div>
              <div class="ai-stat">
                <span class="ai-stat-label">Accuracy</span>
                <span class="ai-stat-value" id="aiAccuracy">--</span>
              </div>
              <div class="ai-stat">
                <span class="ai-stat-label">Model</span>
                <span class="ai-stat-value" id="aiModelName">TF.js</span>
              </div>
            </div>
            <div class="ai-detected-cards" id="aiDetectedCards">
              <span class="ai-detected-label">AI Tracked:</span>
              <span class="ai-detected-none">Waiting for cards...</span>
            </div>
            <div class="ai-instruction ai-auto-mode">
              <strong>ü§ñ FULL AI MODE:</strong> Cards are automatically detected and tracked! The AI recognizes card values using pattern analysis. Manual backup: <kbd>2</kbd>-<kbd>9</kbd>, <kbd>0</kbd>=10, <kbd>J</kbd><kbd>Q</kbd><kbd>K</kbd><kbd>A</kbd>
            </div>
          </div>

          <div class="stream-controls">
            <input type="file" id="videoFileInput" accept="video/*" onchange="loadTrackerVideo(this)" style="display:none">
            <button class="btn-stream primary" onclick="startScreenCapture()" id="btnStartCapture">üì∫ Start Capture</button>
            <button class="btn-stream" onclick="stopScreenCapture()" id="btnStopCapture" style="display:none;">‚èπ Stop</button>
            <button class="btn-stream" onclick="document.getElementById('videoFileInput').click()" id="btnLoadFile" style="display:none;">üìÅ Load File</button>
            <button class="btn-stream" onclick="togglePictureInPicture()" id="btnPiP" disabled>üñº PiP</button>
            <div class="stream-speed">
              <label>Speed:</label>
              <select id="videoSpeed" onchange="setTrackerVideoSpeed(this.value)">
                <option value="0.25">0.25x</option>
                <option value="0.5">0.5x</option>
                <option value="0.75">0.75x</option>
                <option value="1" selected>1x</option>
              </select>
            </div>
          </div>

          <div class="video-timeline" id="videoTimeline" style="display:none;">
            <button class="btn-frame" onclick="trackerVideoStep(-1)">‚èÆ</button>
            <input type="range" id="videoSeekBar" min="0" max="100" value="0" onchange="seekTrackerVideo(this.value)">
            <button class="btn-frame" onclick="trackerVideoStep(1)">‚è≠</button>
            <button class="btn-frame" onclick="trackerVideoPlayPause()" id="btnPlayPause">‚ñ∂</button>
            <span id="videoTimeDisplay">0:00 / 0:00</span>
          </div>

          <!-- Keyboard Shortcuts Reference -->
          <div class="hotkeys-panel">
            <div class="hotkeys-title">Keyboard Shortcuts (Fast Input)</div>
            <div class="hotkeys-grid">
              <span class="hotkey"><kbd>2</kbd>-<kbd>9</kbd> Cards</span>
              <span class="hotkey"><kbd>0</kbd> = 10</span>
              <span class="hotkey"><kbd>J</kbd><kbd>Q</kbd><kbd>K</kbd><kbd>A</kbd></span>
              <span class="hotkey"><kbd>Z</kbd> Undo</span>
              <span class="hotkey"><kbd>Space</kbd> Pause</span>
              <span class="hotkey"><kbd>N</kbd> New Shoe</span>
            </div>
          </div>
        </div>

        <!-- Right Panel: Tracking Interface -->
        <div class="tracking-panel">
          <!-- Live Stats Dashboard -->
          <div class="live-stats-dashboard">
            <div class="stat-card primary">
              <div class="stat-icon">üé∞</div>
              <div class="stat-info">
                <span class="stat-label">Running Count</span>
                <span class="stat-value large" id="liveRC">0</span>
              </div>
            </div>
            <div class="stat-card">
              <div class="stat-icon">üìä</div>
              <div class="stat-info">
                <span class="stat-label">True Count</span>
                <span class="stat-value large" id="liveTC">0.00</span>
              </div>
            </div>
            <div class="stat-card">
              <div class="stat-icon">üÉè</div>
              <div class="stat-info">
                <span class="stat-label">Cards Seen</span>
                <span class="stat-value" id="liveCardsSeen">0 / 416</span>
              </div>
            </div>
            <div class="stat-card">
              <div class="stat-icon">üì¶</div>
              <div class="stat-info">
                <span class="stat-label">Decks Left</span>
                <span class="stat-value" id="liveDecksLeft">8.00</span>
              </div>
            </div>
          </div>

          <!-- Decision Recommendation Panel -->
          <div class="decision-panel" id="decisionPanel">
            <div class="decision-header">
              <span>Current Recommendation</span>
              <span class="edge-display" id="liveEdge">House Edge: 0.50%</span>
            </div>
            <div class="decision-content">
              <div class="bet-recommendation" id="betRecommendation">
                <span class="bet-label">Optimal Bet:</span>
                <span class="bet-value neutral">1 Unit (Wait)</span>
              </div>
              <div class="count-status" id="countStatus">
                <span class="status-neutral">Neutral Count - Basic Strategy</span>
              </div>
              <div class="active-deviations" id="activeDeviations">
                <span class="deviation-label">Active Deviations:</span>
                <span class="no-deviations">None at current count</span>
              </div>
            </div>
          </div>

          <!-- Position Selector -->
          <div class="position-section">
            <div class="position-label">Tracking Position:</div>
            <div class="position-buttons">
              <button class="pos-btn active" onclick="setTrackingPosition('all')" data-pos="all">All Cards</button>
              <button class="pos-btn" onclick="setTrackingPosition('dealer')" data-pos="dealer">Dealer</button>
              <button class="pos-btn" onclick="setTrackingPosition('p1')" data-pos="p1">P1</button>
              <button class="pos-btn" onclick="setTrackingPosition('p2')" data-pos="p2">P2</button>
              <button class="pos-btn" onclick="setTrackingPosition('p3')" data-pos="p3">P3</button>
              <button class="pos-btn" onclick="setTrackingPosition('p4')" data-pos="p4">P4</button>
              <button class="pos-btn" onclick="setTrackingPosition('p5')" data-pos="p5">P5</button>
              <button class="pos-btn" onclick="setTrackingPosition('p6')" data-pos="p6">P6</button>
              <button class="pos-btn" onclick="setTrackingPosition('p7')" data-pos="p7">P7</button>
            </div>
          </div>

          <!-- Card Input Grid -->
          <div class="card-input-section">
            <div class="card-input-label">Click or press key to track card:</div>
            <div class="card-input-grid enhanced">
              <button class="card-btn low" onclick="trackLiveCard('2')" data-key="2">2<span class="key-hint">2</span></button>
              <button class="card-btn low" onclick="trackLiveCard('3')" data-key="3">3<span class="key-hint">3</span></button>
              <button class="card-btn low" onclick="trackLiveCard('4')" data-key="4">4<span class="key-hint">4</span></button>
              <button class="card-btn low" onclick="trackLiveCard('5')" data-key="5">5<span class="key-hint">5</span></button>
              <button class="card-btn low" onclick="trackLiveCard('6')" data-key="6">6<span class="key-hint">6</span></button>
              <button class="card-btn neutral" onclick="trackLiveCard('7')" data-key="7">7<span class="key-hint">7</span></button>
              <button class="card-btn neutral" onclick="trackLiveCard('8')" data-key="8">8<span class="key-hint">8</span></button>
              <button class="card-btn neutral" onclick="trackLiveCard('9')" data-key="9">9<span class="key-hint">9</span></button>
              <button class="card-btn high" onclick="trackLiveCard('10')" data-key="0">10<span class="key-hint">0</span></button>
              <button class="card-btn high" onclick="trackLiveCard('J')" data-key="j">J<span class="key-hint">J</span></button>
              <button class="card-btn high" onclick="trackLiveCard('Q')" data-key="q">Q<span class="key-hint">Q</span></button>
              <button class="card-btn high" onclick="trackLiveCard('K')" data-key="k">K<span class="key-hint">K</span></button>
              <button class="card-btn high ace" onclick="trackLiveCard('A')" data-key="a">A<span class="key-hint">A</span></button>
            </div>
          </div>

          <!-- Action Buttons -->
          <div class="tracker-actions">
            <button class="btn-action undo" onclick="undoLiveCard()">‚Ü© Undo <kbd>Z</kbd></button>
            <button class="btn-action new-shoe" onclick="newLiveShoe()">üîÑ New Shoe <kbd>N</kbd></button>
            <button class="btn-action sync" onclick="syncToMainTable()">üîó Sync to Table</button>
          </div>

          <!-- Live Hand Tracker -->
          <div class="live-hand-section">
            <div class="hand-header">
              <span>Current Hand</span>
              <span class="hand-number" id="liveHandNumber">Hand #1</span>
            </div>
            <div class="hand-display">
              <div class="hand-position">
                <span class="pos-label">Dealer</span>
                <div class="hand-cards" id="liveDealerHand">-</div>
              </div>
              <div class="hand-position player">
                <span class="pos-label">Player</span>
                <div class="hand-cards" id="livePlayerHand">-</div>
                <div class="hand-total" id="livePlayerTotal"></div>
              </div>
            </div>
            <div class="hand-actions">
              <button class="btn-hand" onclick="markHandResult('win')">Win</button>
              <button class="btn-hand" onclick="markHandResult('lose')">Lose</button>
              <button class="btn-hand" onclick="markHandResult('push')">Push</button>
              <button class="btn-hand" onclick="markHandResult('bj')">BJ!</button>
              <button class="btn-hand next" onclick="nextHand()">Next Hand ‚Üí</button>
            </div>
          </div>

          <!-- Recent Cards History -->
          <div class="cards-history">
            <div class="history-header">
              <span>Card History</span>
              <span class="history-count" id="historyCount">0 cards</span>
            </div>
            <div class="history-stream" id="liveCardHistory">
              <span class="empty-history">Cards will appear here as tracked...</span>
            </div>
          </div>

          <!-- Thesis Export Section -->
          <div class="thesis-export">
            <div class="export-header">Thesis Data Export</div>
            <div class="export-buttons">
              <button class="btn-export" onclick="exportThesisJSON()">üìÑ JSON</button>
              <button class="btn-export" onclick="exportThesisCSV()">üìä CSV</button>
              <button class="btn-export" onclick="exportHandHistory()">üé∞ Hands</button>
              <button class="btn-export" onclick="exportSessionReport()">üìã Report</button>
            </div>
            <div class="session-stats" id="sessionStats">
              <span>Hands: <strong id="totalHands">0</strong></span>
              <span>Win Rate: <strong id="winRate">0%</strong></span>
              <span>Time: <strong id="sessionTime">00:00:00</strong></span>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Live Card Tracking - Webcam Panel -->
  <div id="webcamPanel" class="webcam-panel" style="display: none;">
    <div class="webcam-header">
      <span>üìπ LIVE CARD TRACKING</span>
      <div class="webcam-controls-header">
        <button id="btnMinimizeWebcam" class="btn-webcam-control" onclick="toggleWebcamMinimize()">‚àí</button>
        <button id="btnCloseWebcam" class="btn-webcam-control" onclick="closeWebcamPanel()">√ó</button>
      </div>
    </div>
    <div class="webcam-body" id="webcamBody">
      <div class="webcam-video-container">
        <video id="webcamVideo" autoplay playsinline muted></video>
        <canvas id="webcamCanvas" style="display: none;"></canvas>
        <div id="webcamOverlay" class="webcam-overlay"></div>
        <div id="webcamPlaceholder" class="webcam-placeholder">
          <span>üì∑</span>
          <p>Click Start Camera to begin</p>
        </div>
      </div>
      <div class="webcam-controls">
        <button id="btnStartCamera" class="btn-webcam" onclick="startWebcam()">‚ñ∂ Start Camera</button>
        <button id="btnStopCamera" class="btn-webcam btn-danger" onclick="stopWebcam()" style="display: none;">‚¨õ Stop</button>
        <button id="btnCaptureFrame" class="btn-webcam btn-secondary" onclick="captureFrame()" disabled>üì∏ Capture</button>
        <select id="cameraSelect" class="webcam-select" onchange="switchCamera()">
          <option value="">Select Camera...</option>
        </select>
      </div>
      <div class="webcam-status">
        <span>Status: <span id="webcamStatus">Idle</span></span>
        <span>FPS: <span id="webcamFps">0</span></span>
        <span>Detected: <span id="cardsDetected">0</span></span>
        <span>Model: <span id="modelStatus">Not loaded</span></span>
      </div>
      <div class="webcam-model-controls">
        <button id="btnLoadModel" class="btn-webcam btn-secondary" onclick="loadCardDetectionModel()">üß† Load Model</button>
      </div>
      <div class="webcam-detected-cards">
        <div class="detected-header">Detected Cards:</div>
        <div id="detectedCardsList" class="detected-list">No cards detected</div>
        <button id="btnAddDetectedCards" class="btn-webcam btn-success" onclick="addDetectedCardsToGame()" disabled>Add to Game</button>
      </div>
      <div class="webcam-settings">
        <label><input type="checkbox" id="autoDetectEnabled" onchange="toggleAutoDetect()"> Auto-detect</label>
        <label><input type="checkbox" id="autoAddEnabled"> Auto-add to game</label>
        <div class="confidence-slider">
          <label>Confidence: <span id="confidenceValue">70%</span></label>
          <input type="range" id="confidenceThreshold" min="50" max="95" value="70" oninput="updateConfidenceValue()">
        </div>
      </div>
    </div>
  </div>

  <!-- Webcam Toggle Button -->
  <button id="btnToggleWebcam" class="btn-webcam-toggle" onclick="toggleWebcamPanel()" title="Live Card Tracking">üìπ</button>

  <!-- Toast Container -->
  <div id="toastContainer" class="toast-container"></div>

  <!-- Scripts -->
  <script src="js/performance.js?v=1.0.0"></script>
  <script src="js/app.js?v=3.9.64" defer></script>
</body>
</html>
